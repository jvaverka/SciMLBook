<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MIT Parallel Computing and Scientific Machine Learning - 4&nbsp; The Basics of Single Node Parallel Computing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./styles_of_parallelism.html" rel="next">
<link href="./dynamical_systems.html" rel="prev">
<link href="./sciml-book-logo.svg" rel="icon" type="image/svg+xml">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./dynamical_systems.html">Parallel Computing</a></li><li class="breadcrumb-item"><a href="./parallelism_overview.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Basics of Single Node Parallel Computing</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./sciml-book-logo.svg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">MIT Parallel Computing and Scientific Machine Learning</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/jvaverka/SciMLBook" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./MIT-Parallel-Computing-and-Scientific-Machine-Learning.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./MIT-Parallel-Computing-and-Scientific-Machine-Learning.epub">
              <i class="bi bi-bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Parallel Computing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Optimizing Serial Code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sciml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to Scientific Machine Learning through Physics-Informed Neural Networks</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Parallel Computing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dynamical_systems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">How Loops Work, An Introduction to Discrete Dynamics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parallelism_overview.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Basics of Single Node Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./styles_of_parallelism.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Different Flavors of Parallelism</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discretizing_odes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Ordinary Differential Equations, Applications and Discretizations</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Modern Approaches</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./automatic_differentiation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Forward-Mode Automatic Differentiation (AD) via High Dimensional Algebras</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stiff_odes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Solving Stiff Ordinary Differential Equations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimation_identification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Basic Parameter Estimation, Reverse-Mode AD, and Inverse Problems</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./adjoints.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Differentiable Programming and Neural Differential Equations</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Modern Architectures</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mpi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Introduction to MPI.jl</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gpus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">GPU programming</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Advanced Differential Equations</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pdes_and_convolutions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">PDEs, Convolutions, and the Mathematics of Locality</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diffeq_machine_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Mixing Differential Equations and Neural Networks for Physics-Informed Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probabilistic_programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">From Optimization to Probabilistic Programming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./global_sensitivity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Global Sensitivity Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./profiling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Code Profiling and Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Uncertainty Programming, Generalized Uncertainty Quantification</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#youtube-video-link" id="toc-youtube-video-link" class="nav-link active" data-scroll-target="#youtube-video-link"><span class="header-section-number">4.1</span> Youtube Video Link</a></li>
  <li><a href="#managing-threads" id="toc-managing-threads" class="nav-link" data-scroll-target="#managing-threads"><span class="header-section-number">4.2</span> Managing Threads</a>
  <ul class="collapse">
  <li><a href="#concurrency-vs-parallelism-and-green-threads" id="toc-concurrency-vs-parallelism-and-green-threads" class="nav-link" data-scroll-target="#concurrency-vs-parallelism-and-green-threads"><span class="header-section-number">4.2.1</span> Concurrency vs Parallelism and Green Threads</a></li>
  <li><a href="#examples-of-the-differences" id="toc-examples-of-the-differences" class="nav-link" data-scroll-target="#examples-of-the-differences"><span class="header-section-number">4.2.2</span> Examples of the Differences</a></li>
  <li><a href="#multithreading" id="toc-multithreading" class="nav-link" data-scroll-target="#multithreading"><span class="header-section-number">4.2.3</span> Multithreading</a></li>
  <li><a href="#data-parallel-problems" id="toc-data-parallel-problems" class="nav-link" data-scroll-target="#data-parallel-problems"><span class="header-section-number">4.2.4</span> Data-Parallel Problems</a></li>
  <li><a href="#hierarchical-task-based-multithreading-and-dynamic-scheduling" id="toc-hierarchical-task-based-multithreading-and-dynamic-scheduling" class="nav-link" data-scroll-target="#hierarchical-task-based-multithreading-and-dynamic-scheduling"><span class="header-section-number">4.2.5</span> Hierarchical Task-Based Multithreading and Dynamic Scheduling</a></li>
  </ul></li>
  <li><a href="#a-teaser-for-alternative-parallelism-models" id="toc-a-teaser-for-alternative-parallelism-models" class="nav-link" data-scroll-target="#a-teaser-for-alternative-parallelism-models"><span class="header-section-number">4.3</span> A Teaser for Alternative Parallelism Models</a>
  <ul class="collapse">
  <li><a href="#simplest-parallel-code" id="toc-simplest-parallel-code" class="nav-link" data-scroll-target="#simplest-parallel-code"><span class="header-section-number">4.3.1</span> Simplest Parallel Code</a></li>
  <li><a href="#array-based-parallelism" id="toc-array-based-parallelism" class="nav-link" data-scroll-target="#array-based-parallelism"><span class="header-section-number">4.3.2</span> Array-Based Parallelism</a></li>
  <li><a href="#blas-and-standard-libraries" id="toc-blas-and-standard-libraries" class="nav-link" data-scroll-target="#blas-and-standard-libraries"><span class="header-section-number">4.3.3</span> BLAS and Standard Libraries</a></li>
  <li><a href="#mpi" id="toc-mpi" class="nav-link" data-scroll-target="#mpi"><span class="header-section-number">4.3.4</span> MPI</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">4.4</span> Conclusion</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/jvaverka/SciMLBook/edit/main/parallelism_overview.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/jvaverka/SciMLBook/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/jvaverka/SciMLBook/blob/main/parallelism_overview.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Basics of Single Node Parallel Computing</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="youtube-video-link" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="youtube-video-link"><span class="header-section-number">4.1</span> <a href="https://youtu.be/eca6kcFntiE">Youtube Video Link</a></h2>
<p>Moore’s law was the idea that computers double in efficiency at fixed time points, leading to exponentially more computing power over time. This was true for a very long time.</p>
<p><img src="https://assets.weforum.org/editor/large_SOupdi6_TD1Lyud4kWEHmsB5rcslL0q2BB6UCRCEZKE.png" class="img-fluid"></p>
<p>However, sometime in the last decade, computer cores have stopped getting faster.</p>
<blockquote class="blockquote">
<p>The technology that promises to keep Moore’s Law going after 2013 is known as extreme ultraviolet (EUV) lithography. It uses light to write a pattern into a chemical layer on top of a silicon wafer, which is then chemically etched into the silicon to make chip components. EUV lithography uses very high energy ultraviolet light rays that are closer to X-rays than visible light. That’s attractive because EUV light has a short wavelength—around 13 nanometers—which allows for making smaller details than the 193-nanometer ultraviolet light used in lithography today. But EUV has proved surprisingly difficult to perfect.</p>
</blockquote>
<p>-MIT Technology Review</p>
<p>The answer to the “end of Moore’s Law” is Parallel Computing. However, programs need to be specifically designed in order to adequately use parallelism. This lecture will describe at a very high level the forms of parallelism and when they are appropriate. We will then proceed to use shared-memory multithreading to parallelize the simulation of the discrete dynamical system.</p>
</section>
<section id="managing-threads" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="managing-threads"><span class="header-section-number">4.2</span> Managing Threads</h2>
<section id="concurrency-vs-parallelism-and-green-threads" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="concurrency-vs-parallelism-and-green-threads"><span class="header-section-number">4.2.1</span> Concurrency vs Parallelism and Green Threads</h3>
<p>There is a difference between concurrency and parallelism. In a nutshell:</p>
<ul>
<li>Concurrency: Interruptability</li>
<li>Parallelism: Independentability</li>
</ul>
<!-- ![](http://tutorials.jenkov.com/images/java-concurrency/concurrency-vs-parallelism-1.png) -->
<!-- ![](http://tutorials.jenkov.com/images/java-concurrency/concurrency-vs-parallelism-2.png) -->
<p>To start thinking about concurrency, we need to distinguish between a process and a thread. A process is discrete running instance of a computer program. It has allocated memory for the program’s code, its data, a heap, etc. Each process can have many compute threads. These threads are the unit of execution that needs to be done. On each task is its own stack and a virtual CPU (virtual CPU since it’s not the true CPU, since that would require that the task is ON the CPU, which it might not be because the task can be temporarily haulted). The kernel of the operating systems then <em>schedules</em> tasks, which runs them. In order to keep the computer running smooth, <em>context switching</em>, i.e.&nbsp;changing the task that is actually running, happens all the time. This is independent of whether tasks are actually scheduled in parallel or not.</p>
<p><img src="https://blog-assets.risingstack.com/2017/02/kernel-processes-and-threads-1.png" class="img-fluid"></p>
<p><img src="https://dave.cheney.net/wp-content/uploads/2015/08/process.png" class="img-fluid"></p>
<p><img src="https://dave.cheney.net/wp-content/uploads/2015/08/guard-page.png" class="img-fluid"></p>
<p>Each thread has its own stack associated with it.</p>
<p><img src="https://dave.cheney.net/wp-content/uploads/2015/08/threads.png" class="img-fluid"></p>
<p><img src="https://dave.cheney.net/wp-content/uploads/2015/08/stack-growth.png" class="img-fluid"></p>
<p>This is an important distinction because many tasks may need to be ran concurrently but without parallelism. Examples of this are input/output (I/O). For example, in a game you may want to be updating the graphics, but the moment a user clicks you want to handle that event. You do not necessarily need to have these running in parallel, but you need the event handling task to be running concurrently to the processing of the game.</p>
<p><img src="https://assets.weforum.org/editor/large_MbM-fLOQDkOW_Gvmj_X5ZO9ys6dDF4EMrtiVQG-Fy4Y.png" class="img-fluid"></p>
<p>Data handling is the key area of scientific computing where green threads (concurrent non-parallel threads) show up. For data handling, one may need to send a signal that causes a message to start being passed. Alternative hardware take over at that point. This alternative hardware is a processor specific for an I/O bus, like the controller for the SSD, modem, GPU, or Infiniband. It will be polled, then it will execute the command, and give the result. There are two variants:</p>
<ul>
<li>Non-Blocking vs Blocking: Whether the thread will periodically poll for whether that task is complete, or whether it should wait for the task to complete before doing anything else</li>
<li>Synchronous vs Asynchronus: Whether to execute the operation as initiated by the program or as a response to an event from the kernel.</li>
</ul>
<p>I/O operations cause a <em>privileged context switch</em>, allowing the task which is handling the I/O to directly be switched to in order to continue actions.</p>
<section id="the-main-event-loop" class="level4" data-number="4.2.1.1">
<h4 data-number="4.2.1.1" class="anchored" data-anchor-id="the-main-event-loop"><span class="header-section-number">4.2.1.1</span> The Main Event Loop</h4>
<p>Julia, along with other languages with a runtime (Javascript, Go, etc.) at its core is a single process running an event loop. This event loop has is the main thread, and “Julia program” or “script” that one is running is actually ran in a green thread that is controlled by the main event loop. The event loop takes over to look for other work whenever the program hits a <em>yield point</em>. More yield points allows for more aggressive task switching, while it also means more switches to the event loop which <em>suspends</em> the numerical task, i.e. making it slower. Thus yielding shouldn’t interrupt the main loop!</p>
<p>This is one area where languages can wildly differ in implementation. Languages structured for lots of I/O and input handling, like Javascript, have yield points at every line (it’s an interpreted language and therefore the interpreter can always take control). In Julia, the yield points are minimized. The common yield points are allocations and I/O (<code>println</code>). This means that a tight non-allocating inner loop will not have any yield points and will be a thread that is not interruptible. While this is great for numerical performance, it is something to be aware of.</p>
<p>Side effect: if you run a long tight loop and wish to exit it, you may try <code>Ctrl + C</code> and see that it doesn’t work. This is because interrupts are handled by the event loop. The event loop is never re-entered until after your tight numerical loop, and therefore you have the waiting occur. If you hit <code>Ctrl + C</code> multiple times, you will escalate the interruption until the OS takes over and then this is handled by the signal handling of the OS’s event loop, which sends a higher level interrupt which Julia handles the moment the safety locks says it’s okay (these locks occur during memory allocations to ensure that memory is not corrupted).</p>
</section>
<section id="asynchronous-calling-example" class="level4" data-number="4.2.1.2">
<h4 data-number="4.2.1.2" class="anchored" data-anchor-id="asynchronous-calling-example"><span class="header-section-number">4.2.1.2</span> Asynchronous Calling Example</h4>
<p>This example will become more clear when we get to distributed computing, but for think of <code>remotecall_fetch</code> as a way to run a command on a different computer. What we want to do is start all of the commands at once, and then wait for all the results before finishing the loop. We will use <code>@async</code> to make the call to <code>remotecall_fetch</code> be non-blocking, i.e.&nbsp;it’ll start the job and only poll infrequently to find out when the other machine has completed the job and returned the result. We then add <code>@sync</code> to the loop, which will only continue the loop after all of the green threads have fetched the result. Otherwise, it’s possible that <code>a[idx]</code> may not be filled yet, since the thread may not have fetched the result!</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="cf">begin</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{Any}</span>(<span class="cn">undef</span>,<span class="fu">nworkers</span>())</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="cf">for</span> (idx, pid) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">workers</span>())</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@async</span> a[idx] <span class="op">=</span> <span class="fu">remotecall_fetch</span>(sleep, pid, <span class="fl">2</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same can be done for writing to the disk. <code>@async</code> is a quick shorthand for spawning a green thread which will handle that I/O operation, and the main event loop will keep switching between them until they are all handled. <code>@sync</code> encodes that the program will not continue until all green threads are handled. This could be done more manually with <code>Task</code> and <code>Channel</code>s, which will be something we touch on in the future.</p>
</section>
</section>
<section id="examples-of-the-differences" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="examples-of-the-differences"><span class="header-section-number">4.2.2</span> Examples of the Differences</h3>
<p>Synchronous = Thread will complete an action</p>
<p>Blocking = Thread will wait until action is completed</p>
<ul>
<li>Asynchronous + Non-Blocking: I/O</li>
<li>Asynchronous + Blocking: Threaded atomics (demonstrated next lecture)</li>
<li>Synchronous + Blocking: Standard computing, <code>@sync</code></li>
<li>Synchronous + Non-Blocking: Webservers where an I/O operation can be performed, but one never checks if the operation is completed.</li>
</ul>
</section>
<section id="multithreading" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="multithreading"><span class="header-section-number">4.2.3</span> Multithreading</h3>
<p>If your threads are independent, then it may make sense to run them in parallel. This is the form of parallelism known as multithreading. To understand the data that is available in a multithreaded setup, let’s look at the picture of threads again:</p>
<p><img src="https://blog-assets.risingstack.com/2017/02/kernel-processes-and-threads-1.png" class="img-fluid"></p>
<p>Each thread has its own call stack, but it’s the process that holds the heap. This means that dynamically-sized heap allocated objects are shared between threads with no cost, a setup known as shared-memory computing.</p>
<section id="loop-based-multithreading-with-threads" class="level4" data-number="4.2.3.1">
<h4 data-number="4.2.3.1" class="anchored" data-anchor-id="loop-based-multithreading-with-threads"><span class="header-section-number">4.2.3.1</span> Loop-Based Multithreading with <span class="citation" data-cites="threads">(<a href="references.html#ref-threads" role="doc-biblioref"><strong>threads?</strong></a>)</span></h4>
<p>Let’s look back at our Lorenz dynamical system from before:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">StaticArrays</span>, <span class="bu">BenchmarkTools</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">lorenz</span>(u,p)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  α,σ,ρ,β <span class="op">=</span> p</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@inbounds</span> <span class="cf">begin</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    du1 <span class="op">=</span> u[<span class="fl">1</span>] <span class="op">+</span> <span class="fu">α*</span>(<span class="fu">σ*</span>(u[<span class="fl">2</span>]<span class="op">-</span>u[<span class="fl">1</span>]))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    du2 <span class="op">=</span> u[<span class="fl">2</span>] <span class="op">+</span> <span class="fu">α*</span>(u[<span class="fl">1</span>]<span class="fu">*</span>(ρ<span class="op">-</span>u[<span class="fl">3</span>]) <span class="op">-</span> u[<span class="fl">2</span>])</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    du3 <span class="op">=</span> u[<span class="fl">3</span>] <span class="op">+</span> <span class="fu">α*</span>(u[<span class="fl">1</span>]<span class="op">*</span>u[<span class="fl">2</span>] <span class="op">-</span> β<span class="op">*</span>u[<span class="fl">3</span>])</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@SVector</span> [du1,du2,du3]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve_system_save!</span>(u,f,u0,p,n)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@inbounds</span> u[<span class="fl">1</span>] <span class="op">=</span> u0</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@inbounds</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(u)<span class="op">-</span><span class="fl">1</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    u[i<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> <span class="fu">f</span>(u[i],p)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  u</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> (<span class="fl">0.02</span>,<span class="fl">10.0</span>,<span class="fl">28.0</span>,<span class="fl">8</span><span class="op">/</span><span class="fl">3</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{typeof(@SVector([1.0,0.0,0.0]))}</span>(<span class="cn">undef</span>,<span class="fl">1000</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">solve_system_save!</span>(u,lorenz,<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p,<span class="fl">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.086 μs (0 allocations: 0 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [1.0, 0.0, 0.0]
 [0.8, 0.56, 0.0]
 [0.752, 0.9968000000000001, 0.008960000000000001]
 [0.80096, 1.3978492416000001, 0.023474005333333336]
 [0.92033784832, 1.8180538219817644, 0.04461448495326095]
 [1.099881043052353, 2.296260732619613, 0.07569952060880669]
 [1.339156980965805, 2.864603692722823, 0.12217448583728006]
 [1.6442463233172087, 3.5539673118971193, 0.19238159391549564]
 [2.026190521033191, 4.397339452147425, 0.2989931959555302]
 [2.5004203072560376, 5.431943011293093, 0.4612438424853632]
 [3.0867248480634486, 6.700473453723668, 0.7082869831520391]
 [3.8094745691954923, 8.25130415895562, 1.0841620354518975]
 [4.697840487147518, 10.136982080467158, 1.655002727352565]
 ⋮
 [10.49730559336705, 4.660822889495989, 35.336831929448614]
 [9.330009052592839, 3.0272670946941713, 34.430722536963344]
 [8.069460661013105, 1.766747763108672, 33.159305922954225]
 [6.8089180814322185, 0.8987564841782779, 31.6759436385101]
 [5.6268857619814305, 0.3801973723631693, 30.108951163308078]
 [4.577548084057778, 0.13525687944525802, 28.545926978224173]
 [3.6890898431352737, 0.08257160199224252, 27.035860436772758]
 [2.9677861949066675, 0.15205611935372762, 25.600040161309696]
 [2.4046401797960795, 0.2914663505185634, 24.24373008707723]
 [1.9820054139405763, 0.46628657468365653, 22.964748583050085]
 [1.6788616460891923, 0.6565587545689172, 21.758445642263496]
 [1.4744010677851374, 0.8530017039412324, 20.62004063423844]</code></pre>
</div>
</div>
<p>In order to use multithreading on this code, we need to take a look at the dependency graph and see what items can be calculated independently of each other. Notice that</p>
<pre><code>σ*(u[2]-u[1])
ρ-u[3]
u[1]*u[2]
β*u[3]</code></pre>
<p>are all independent operations, so in theory we could split those off to different threads, move up, etc.</p>
<p>Or we can have three threads:</p>
<pre><code>u[1] + α*(σ*(u[2]-u[1]))
u[2] + α*(u[1]*(ρ-u[3]) - u[2])
u[3] + α*(u[1]*u[2] - β*u[3])</code></pre>
<p>all don’t depend on the output of each other, so these tasks can be run in parallel. We can do this by using Julia’s <code>Threads.@threads</code> macro which puts each of the computations of a loop in a different thread. The threaded loops do not allow you to return a value, so how do you build up the values for the <code>@SVector</code>?</p>
<p>…?</p>
<p>…?</p>
<p>…?</p>
<p>It’s not possible! To understand why, let’s look at the picture again:</p>
<p><img src="https://blog-assets.risingstack.com/2017/02/kernel-processes-and-threads-1.png" class="img-fluid"></p>
<p>There is a shared heap, but the stacks are thread local. This means that a value cannot be stack allocated in one thread and magically appear when re-entering the main thread: it needs to go on the heap somewhere. But if it needs to go onto the heap, then it makes sense for us to have preallocated its location. But if we want to preallocate <code>du[1]</code>, <code>du[2]</code>, and <code>du[3]</code>, then it makes sense to use the fully non-allocating update form:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">lorenz!</span>(du,u,p)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  α,σ,ρ,β <span class="op">=</span> p</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@inbounds</span> <span class="cf">begin</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    du[<span class="fl">1</span>] <span class="op">=</span> u[<span class="fl">1</span>] <span class="op">+</span> <span class="fu">α*</span>(<span class="fu">σ*</span>(u[<span class="fl">2</span>]<span class="op">-</span>u[<span class="fl">1</span>]))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    du[<span class="fl">2</span>] <span class="op">=</span> u[<span class="fl">2</span>] <span class="op">+</span> <span class="fu">α*</span>(u[<span class="fl">1</span>]<span class="fu">*</span>(ρ<span class="op">-</span>u[<span class="fl">3</span>]) <span class="op">-</span> u[<span class="fl">2</span>])</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    du[<span class="fl">3</span>] <span class="op">=</span> u[<span class="fl">3</span>] <span class="op">+</span> <span class="fu">α*</span>(u[<span class="fl">1</span>]<span class="op">*</span>u[<span class="fl">2</span>] <span class="op">-</span> β<span class="op">*</span>u[<span class="fl">3</span>])</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve_system_save_iip!</span>(u,f,u0,p,n)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@inbounds</span> u[<span class="fl">1</span>] <span class="op">=</span> u0</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@inbounds</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(u)<span class="op">-</span><span class="fl">1</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(u[i<span class="op">+</span><span class="fl">1</span>],u[i],p)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  u</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> (<span class="fl">0.02</span>,<span class="fl">10.0</span>,<span class="fl">28.0</span>,<span class="fl">8</span><span class="op">/</span><span class="fl">3</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> [<span class="fu">Vector</span><span class="dt">{Float64}</span>(<span class="cn">undef</span>,<span class="fl">3</span>) for i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>]</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">solve_system_save_iip!</span>(u,lorenz!,[<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>],p,<span class="fl">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.982 μs (1 allocation: 80 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>1000-element Vector{Vector{Float64}}:
 [1.0, 0.0, 0.0]
 [0.8, 0.56, 0.0]
 [0.752, 0.9968000000000001, 0.008960000000000001]
 [0.80096, 1.3978492416000001, 0.023474005333333336]
 [0.92033784832, 1.8180538219817644, 0.04461448495326095]
 [1.099881043052353, 2.296260732619613, 0.07569952060880669]
 [1.339156980965805, 2.864603692722823, 0.12217448583728006]
 [1.6442463233172087, 3.5539673118971193, 0.19238159391549564]
 [2.026190521033191, 4.397339452147425, 0.2989931959555302]
 [2.5004203072560376, 5.431943011293093, 0.4612438424853632]
 [3.0867248480634486, 6.700473453723668, 0.7082869831520391]
 [3.8094745691954923, 8.25130415895562, 1.0841620354518975]
 [4.697840487147518, 10.136982080467158, 1.655002727352565]
 ⋮
 [10.49730559336705, 4.660822889495989, 35.336831929448614]
 [9.330009052592839, 3.0272670946941713, 34.430722536963344]
 [8.069460661013105, 1.766747763108672, 33.159305922954225]
 [6.8089180814322185, 0.8987564841782779, 31.6759436385101]
 [5.6268857619814305, 0.3801973723631693, 30.108951163308078]
 [4.577548084057778, 0.13525687944525802, 28.545926978224173]
 [3.6890898431352737, 0.08257160199224252, 27.035860436772758]
 [2.9677861949066675, 0.15205611935372762, 25.600040161309696]
 [2.4046401797960795, 0.2914663505185634, 24.24373008707723]
 [1.9820054139405763, 0.46628657468365653, 22.964748583050085]
 [1.6788616460891923, 0.6565587545689172, 21.758445642263496]
 [1.4744010677851374, 0.8530017039412324, 20.62004063423844]</code></pre>
</div>
</div>
<p>and now we multithread:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Base.Threads</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">lorenz_mt!</span>(du,u,p)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  α,σ,ρ,β <span class="op">=</span> p</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> du<span class="op">=</span>du, u<span class="op">=</span>u, p<span class="op">=</span>p</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      <span class="pp">@inbounds</span> <span class="cf">begin</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>          du[<span class="fl">1</span>] <span class="op">=</span> u[<span class="fl">1</span>] <span class="op">+</span> <span class="fu">α*</span>(<span class="fu">σ*</span>(u[<span class="fl">2</span>]<span class="op">-</span>u[<span class="fl">1</span>]))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elseif</span> i <span class="op">==</span> <span class="fl">2</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>          du[<span class="fl">2</span>] <span class="op">=</span> u[<span class="fl">2</span>] <span class="op">+</span> <span class="fu">α*</span>(u[<span class="fl">1</span>]<span class="fu">*</span>(ρ<span class="op">-</span>u[<span class="fl">3</span>]) <span class="op">-</span> u[<span class="fl">2</span>])</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>          du[<span class="fl">3</span>] <span class="op">=</span> u[<span class="fl">3</span>] <span class="op">+</span> <span class="fu">α*</span>(u[<span class="fl">1</span>]<span class="op">*</span>u[<span class="fl">2</span>] <span class="op">-</span> β<span class="op">*</span>u[<span class="fl">3</span>])</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="cn">nothing</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="cn">nothing</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve_system_save_iip!</span>(u,f,u0,p,n)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@inbounds</span> u[<span class="fl">1</span>] <span class="op">=</span> u0</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@inbounds</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(u)<span class="op">-</span><span class="fl">1</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(u[i<span class="op">+</span><span class="fl">1</span>],u[i],p)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  u</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> (<span class="fl">0.02</span>,<span class="fl">10.0</span>,<span class="fl">28.0</span>,<span class="fl">8</span><span class="op">/</span><span class="fl">3</span>)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> [<span class="fu">Vector</span><span class="dt">{Float64}</span>(<span class="cn">undef</span>,<span class="fl">3</span>) for i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>]</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">solve_system_save_iip!</span>(u,lorenz_mt!,[<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>],p,<span class="fl">1000</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  1.332 ms (6994 allocations: 671.28 KiB)</code></pre>
</div>
</div>
<p><strong>Parallelism doesn’t always make things faster</strong>. There are two costs associated with this code. For one, we had to go to the slower heap+mutation version, so its implementation starting point is slower. But secondly, and more importantly, the cost of spinning a new thread is non-negligible. In fact, here we can see that it even needs to make a small allocation for the new context. The total cost is on the order of It’s on the order of 50ns: not huge, but something to take note of. So what we’ve done is taken almost free calculations and made them ~50ns by making each in a different thread, instead of just having it be one thread with one call stack.</p>
<p>The moral of the story is that you need to make sure that there’s enough work per thread in order to effectively accelerate a program with parallelism.</p>
</section>
</section>
<section id="data-parallel-problems" class="level3" data-number="4.2.4">
<h3 data-number="4.2.4" class="anchored" data-anchor-id="data-parallel-problems"><span class="header-section-number">4.2.4</span> Data-Parallel Problems</h3>
<p>So not every setup is amenable to parallelism. Dynamical systems are notorious for being quite difficult to parallelize because the dependency of the future time step on the previous time step is clear, meaning that one cannot easily “parallelize through time” (though it is possible, which we will study later).</p>
<p>However, one common way that these systems are generally parallelized is in their inputs. The following questions allow for independent simulations:</p>
<ul>
<li>What steady state does an input <code>u0</code> go to for some list/region of initial conditions?</li>
<li>How does the solution very when I use a different <code>p</code>?</li>
</ul>
<p>The problem has a few descriptions. For one, it’s called an <em>embarrassingly parallel</em> problem since the problem can remain largely intact to solve the parallelism problem. To solve this, we can use the exact same <code>solve_system_save_iip!</code>, and just change how we are calling it. Secondly, this is called a <em>data parallel</em> problem, since it parallelized by splitting up the input data (here, the possible <code>u0</code> or <code>p</code>s) and acting on them independently.</p>
<section id="multithreaded-parameter-searches" class="level4" data-number="4.2.4.1">
<h4 data-number="4.2.4.1" class="anchored" data-anchor-id="multithreaded-parameter-searches"><span class="header-section-number">4.2.4.1</span> Multithreaded Parameter Searches</h4>
<p>Now let’s multithread our parameter search. Let’s say we wanted to compute the mean of the values in the trajectory. For a single input pair, we can compute that like:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Statistics</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">compute_trajectory_mean</span>(u0,p)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  u <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{typeof(@SVector([1.0,0.0,0.0]))}</span>(<span class="cn">undef</span>,<span class="fl">1000</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve_system_save!</span>(u,lorenz,u0,p,<span class="fl">1000</span>);</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(u)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">compute_trajectory_mean</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.755 μs (3 allocations: 23.52 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>3-element SVector{3, Float64} with indices SOneTo(3):
 -0.3114996234648468
 -0.30974901748976497
 26.02460355858298</code></pre>
</div>
</div>
<p>We can make this faster by preallocating the <em>cache</em> vector <code>u</code>. For example, we can globalize it:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{typeof(@SVector([1.0,0.0,0.0]))}</span>(<span class="cn">undef</span>,<span class="fl">1000</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">compute_trajectory_mean2</span>(u0,p)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># u is automatically captured</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve_system_save!</span>(u,lorenz,u0,p,<span class="fl">1000</span>);</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(u)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">compute_trajectory_mean2</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.594 μs (3 allocations: 112 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>3-element SVector{3, Float64} with indices SOneTo(3):
 -0.3114996234648468
 -0.30974901748976497
 26.02460355858298</code></pre>
</div>
</div>
<p>But this is still allocating? The issue with this code is that <code>u</code> is a global, and captured globals cannot be inferred because their type can change at any time. Thus what we can do instead is capture a constant:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> _u_cache <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{typeof(@SVector([1.0,0.0,0.0]))}</span>(<span class="cn">undef</span>,<span class="fl">1000</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">compute_trajectory_mean3</span>(u0,p)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># u is automatically captured</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve_system_save!</span>(_u_cache,lorenz,u0,p,<span class="fl">1000</span>);</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(_u_cache)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">compute_trajectory_mean3</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.437 μs (1 allocation: 32 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>3-element SVector{3, Float64} with indices SOneTo(3):
 -0.3114996234648468
 -0.30974901748976497
 26.02460355858298</code></pre>
</div>
</div>
<p>Now it’s just allocating the output. The other way to do this is to use a <em>closure</em> which encapsulates the cache data:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">_compute_trajectory_mean4</span>(u,u0,p)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve_system_save!</span>(u,lorenz,u0,p,<span class="fl">1000</span>);</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(u)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">compute_trajectory_mean4</span>(u0,p) <span class="op">=</span> <span class="fu">_compute_trajectory_mean4</span>(_u_cache,u0,p)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">compute_trajectory_mean4</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.437 μs (1 allocation: 32 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>3-element SVector{3, Float64} with indices SOneTo(3):
 -0.3114996234648468
 -0.30974901748976497
 26.02460355858298</code></pre>
</div>
</div>
<p>This is the same, but a bit more explicit. Now let’s create our parameter search function. Let’s take a sample of parameters:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ps <span class="op">=</span> [(<span class="fl">0.02</span>,<span class="fl">10.0</span>,<span class="fl">28.0</span>,<span class="fl">8</span><span class="op">/</span><span class="fl">3</span>) <span class="op">.*</span> (<span class="fl">1.0</span>,<span class="fu">rand</span>(<span class="fl">3</span>)<span class="op">...</span>) for i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>1000-element Vector{NTuple{4, Float64}}:
 (0.02, 2.906028730747081, 25.815448683561712, 1.12275960676391)
 (0.02, 9.113888679754554, 23.396345437832256, 0.7087562836042887)
 (0.02, 5.624281003968744, 13.659741289695551, 0.4208787410209084)
 (0.02, 8.984206004881038, 0.6852615071967283, 1.0301245930254095)
 (0.02, 4.2694439608822154, 4.9471629140946405, 2.3050770138904744)
 (0.02, 7.663425652277925, 18.64683941659189, 0.7363023476241628)
 (0.02, 4.709434330622436, 26.792899558395884, 0.37439480474450804)
 (0.02, 8.831670441492465, 16.84462530625224, 0.021743723916777626)
 (0.02, 8.553449211066816, 9.804064155048039, 0.7496459573762918)
 (0.02, 0.4565144731650128, 9.349563328382146, 2.2635468681224284)
 (0.02, 8.42290976678019, 14.966673067788223, 1.1960051176820123)
 (0.02, 0.5457585911274876, 24.90136619584543, 1.3109669223727853)
 (0.02, 0.5359945718426307, 14.307891013960985, 1.9546348854959956)
 ⋮
 (0.02, 1.7204623896087134, 25.287843081510555, 0.3252568576015632)
 (0.02, 7.844463934360588, 4.757745483226857, 1.781725005525443)
 (0.02, 2.8711699406052205, 4.087444438946797, 1.4811591925337435)
 (0.02, 3.902751304527816, 6.238336076607061, 1.2705785287011333)
 (0.02, 9.968337747303584, 5.293795065732924, 1.303275829403436)
 (0.02, 7.708774005658567, 5.735602222665191, 2.0789871634786685)
 (0.02, 2.12164254935724, 8.860777750306905, 1.289277966433394)
 (0.02, 9.569874092656468, 6.865041625393758, 2.5301436950975873)
 (0.02, 8.009180587249597, 10.593322579474947, 2.362216817235268)
 (0.02, 8.666632542262393, 8.944711266322507, 0.02674328422848197)
 (0.02, 7.308376816435307, 2.573780328389054, 0.9360601003642579)
 (0.02, 0.5885533401797627, 5.544287667215732, 0.2478493970596694)</code></pre>
</div>
</div>
<p>And let’s get the mean of the trajectory for each of the parameters.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>serial_out <span class="op">=</span> <span class="fu">map</span>(p <span class="op">-&gt;</span> <span class="fu">compute_trajectory_mean4</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p),ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [1.2870613149922208, 1.1438117377304484, 22.669697978635234]
 [-0.097034701516529, -0.08504573089716216, 22.37001310300846]
 [0.27821116678919566, 0.27002118086184895, 12.235995564476475]
 [0.017555205468589588, 0.011991074160098073, 0.0005694144205018892]
 [2.9341064618083235, 2.957720277786962, 3.7631308833438184]
 [0.08355705930996428, 0.09868312584495192, 16.708323298061178]
 [0.1439809343709656, 0.1335020515226761, 26.897349357733248]
 [0.1645878209199906, 0.15892637778403598, 29.25441870590682]
 [0.023896881157504005, -0.013675090924136792, 7.4843300243334365]
 [4.106839222388996, 4.473461790124109, 7.9214466035819635]
 [-0.47550108258884005, -0.4860137926531155, 12.734635921351629]
 [5.440942288045614, 5.862161117104718, 23.130221311332342]
 [4.892880857532143, 5.275366330814495, 12.792226972706137]
 ⋮
 [0.6423401153616347, 0.7359944325332999, 23.732878946460538]
 [2.519234311063701, 2.529353415928587, 3.5827775800975536]
 [2.088308258334852, 2.1081397117252565, 2.9312902609659215]
 [2.442287584724364, 2.462780413293451, 4.902743083455716]
 [2.2888836655888816, 2.2957369635098184, 4.09734744761817]
 [3.0525482059827014, 3.0664148208970974, 4.531257717050107]
 [3.0198041858344693, 3.0717061281815505, 7.337327433546069]
 [3.7455104424898713, 3.7604129809004503, 5.631139370594428]
 [-3.7532028322749538, -3.783303266679652, 8.669842002760918]
 [0.16487278105552758, 0.15910352757025786, 12.675401664157413]
 [1.1817629127943725, 1.1832218915995645, 1.4615938649753042]
 [1.0866052697001025, 1.09106295335647, 4.324846322028256]</code></pre>
</div>
</div>
<p>Now let’s do this with multithreading:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">tmap</span>(f,ps)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  out <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{typeof(@SVector([1.0,0.0,0.0]))}</span>(<span class="cn">undef</span>,<span class="fl">1000</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># each loop part is using a different part of the data</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    out[i] <span class="op">=</span> <span class="fu">f</span>(ps[i])</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>threaded_out <span class="op">=</span> <span class="fu">tmap</span>(p <span class="op">-&gt;</span> <span class="fu">compute_trajectory_mean4</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p),ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [1.2870613149922208, 1.1438117377304484, 22.669697978635234]
 [-0.097034701516529, -0.08504573089716216, 22.37001310300846]
 [0.27821116678919566, 0.27002118086184895, 12.235995564476475]
 [0.017555205468589588, 0.011991074160098073, 0.0005694144205018892]
 [2.9341064618083235, 2.957720277786962, 3.7631308833438184]
 [0.08355705930996428, 0.09868312584495192, 16.708323298061178]
 [0.1439809343709656, 0.1335020515226761, 26.897349357733248]
 [0.1645878209199906, 0.15892637778403598, 29.25441870590682]
 [0.023896881157504005, -0.013675090924136792, 7.4843300243334365]
 [4.106839222388996, 4.473461790124109, 7.9214466035819635]
 [-0.47550108258884005, -0.4860137926531155, 12.734635921351629]
 [5.440942288045614, 5.862161117104718, 23.130221311332342]
 [4.892880857532143, 5.275366330814495, 12.792226972706137]
 ⋮
 [0.6423401153616347, 0.7359944325332999, 23.732878946460538]
 [2.519234311063701, 2.529353415928587, 3.5827775800975536]
 [2.088308258334852, 2.1081397117252565, 2.9312902609659215]
 [2.442287584724364, 2.462780413293451, 4.902743083455716]
 [2.2888836655888816, 2.2957369635098184, 4.09734744761817]
 [3.0525482059827014, 3.0664148208970974, 4.531257717050107]
 [3.0198041858344693, 3.0717061281815505, 7.337327433546069]
 [3.7455104424898713, 3.7604129809004503, 5.631139370594428]
 [-3.7532028322749538, -3.783303266679652, 8.669842002760918]
 [0.16487278105552758, 0.15910352757025786, 12.675401664157413]
 [1.1817629127943725, 1.1832218915995645, 1.4615938649753042]
 [1.0866052697001025, 1.09106295335647, 4.324846322028256]</code></pre>
</div>
</div>
<p>Let’s check the output:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>serial_out <span class="op">-</span> threaded_out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 ⋮
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]</code></pre>
</div>
</div>
<p>Oh no, we don’t get the same answer! What happened?</p>
<p>The answer is the caching. Every single thread is using <code>_u_cache</code> as the cache, and so while one is writing into it the other is reading out of it, and thus is getting the value written to it from the wrong cache!</p>
<p>To fix this, what we need is a different heap per thread:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> _u_cache_threads <span class="op">=</span> [<span class="fu">Vector</span><span class="dt">{typeof(@SVector([1.0,0.0,0.0]))}</span>(<span class="cn">undef</span>,<span class="fl">1000</span>) for i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="bu">Threads</span>.<span class="fu">nthreads</span>()]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">compute_trajectory_mean5</span>(u0,p)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># u is automatically captured</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve_system_save!</span>(_u_cache_threads[<span class="bu">Threads</span>.<span class="fu">threadid</span>()],lorenz,u0,p,<span class="fl">1000</span>);</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(_u_cache_threads[<span class="bu">Threads</span>.<span class="fu">threadid</span>()])</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">compute_trajectory_mean5</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.441 μs (1 allocation: 32 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>3-element SVector{3, Float64} with indices SOneTo(3):
 -0.3114996234648468
 -0.30974901748976497
 26.02460355858298</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>serial_out <span class="op">=</span> <span class="fu">map</span>(p <span class="op">-&gt;</span> <span class="fu">compute_trajectory_mean5</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p),ps)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>threaded_out <span class="op">=</span> <span class="fu">tmap</span>(p <span class="op">-&gt;</span> <span class="fu">compute_trajectory_mean5</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p),ps)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>serial_out <span class="op">-</span> threaded_out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 ⋮
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]
 [0.0, 0.0, 0.0]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> serial_out <span class="op">=</span> <span class="fu">map</span>(p <span class="op">-&gt;</span> <span class="fu">compute_trajectory_mean5</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p),ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.478 ms (3 allocations: 23.50 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [1.2870613149922208, 1.1438117377304484, 22.669697978635234]
 [-0.097034701516529, -0.08504573089716216, 22.37001310300846]
 [0.27821116678919566, 0.27002118086184895, 12.235995564476475]
 [0.017555205468589588, 0.011991074160098073, 0.0005694144205018892]
 [2.9341064618083235, 2.957720277786962, 3.7631308833438184]
 [0.08355705930996428, 0.09868312584495192, 16.708323298061178]
 [0.1439809343709656, 0.1335020515226761, 26.897349357733248]
 [0.1645878209199906, 0.15892637778403598, 29.25441870590682]
 [0.023896881157504005, -0.013675090924136792, 7.4843300243334365]
 [4.106839222388996, 4.473461790124109, 7.9214466035819635]
 [-0.47550108258884005, -0.4860137926531155, 12.734635921351629]
 [5.440942288045614, 5.862161117104718, 23.130221311332342]
 [4.892880857532143, 5.275366330814495, 12.792226972706137]
 ⋮
 [0.6423401153616347, 0.7359944325332999, 23.732878946460538]
 [2.519234311063701, 2.529353415928587, 3.5827775800975536]
 [2.088308258334852, 2.1081397117252565, 2.9312902609659215]
 [2.442287584724364, 2.462780413293451, 4.902743083455716]
 [2.2888836655888816, 2.2957369635098184, 4.09734744761817]
 [3.0525482059827014, 3.0664148208970974, 4.531257717050107]
 [3.0198041858344693, 3.0717061281815505, 7.337327433546069]
 [3.7455104424898713, 3.7604129809004503, 5.631139370594428]
 [-3.7532028322749538, -3.783303266679652, 8.669842002760918]
 [0.16487278105552758, 0.15910352757025786, 12.675401664157413]
 [1.1817629127943725, 1.1832218915995645, 1.4615938649753042]
 [1.0866052697001025, 1.09106295335647, 4.324846322028256]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> threaded_out <span class="op">=</span> <span class="fu">tmap</span>(p <span class="op">-&gt;</span> <span class="fu">compute_trajectory_mean5</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p),ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.438 ms (9 allocations: 24.12 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [1.2870613149922208, 1.1438117377304484, 22.669697978635234]
 [-0.097034701516529, -0.08504573089716216, 22.37001310300846]
 [0.27821116678919566, 0.27002118086184895, 12.235995564476475]
 [0.017555205468589588, 0.011991074160098073, 0.0005694144205018892]
 [2.9341064618083235, 2.957720277786962, 3.7631308833438184]
 [0.08355705930996428, 0.09868312584495192, 16.708323298061178]
 [0.1439809343709656, 0.1335020515226761, 26.897349357733248]
 [0.1645878209199906, 0.15892637778403598, 29.25441870590682]
 [0.023896881157504005, -0.013675090924136792, 7.4843300243334365]
 [4.106839222388996, 4.473461790124109, 7.9214466035819635]
 [-0.47550108258884005, -0.4860137926531155, 12.734635921351629]
 [5.440942288045614, 5.862161117104718, 23.130221311332342]
 [4.892880857532143, 5.275366330814495, 12.792226972706137]
 ⋮
 [0.6423401153616347, 0.7359944325332999, 23.732878946460538]
 [2.519234311063701, 2.529353415928587, 3.5827775800975536]
 [2.088308258334852, 2.1081397117252565, 2.9312902609659215]
 [2.442287584724364, 2.462780413293451, 4.902743083455716]
 [2.2888836655888816, 2.2957369635098184, 4.09734744761817]
 [3.0525482059827014, 3.0664148208970974, 4.531257717050107]
 [3.0198041858344693, 3.0717061281815505, 7.337327433546069]
 [3.7455104424898713, 3.7604129809004503, 5.631139370594428]
 [-3.7532028322749538, -3.783303266679652, 8.669842002760918]
 [0.16487278105552758, 0.15910352757025786, 12.675401664157413]
 [1.1817629127943725, 1.1832218915995645, 1.4615938649753042]
 [1.0866052697001025, 1.09106295335647, 4.324846322028256]</code></pre>
</div>
</div>
</section>
</section>
<section id="hierarchical-task-based-multithreading-and-dynamic-scheduling" class="level3" data-number="4.2.5">
<h3 data-number="4.2.5" class="anchored" data-anchor-id="hierarchical-task-based-multithreading-and-dynamic-scheduling"><span class="header-section-number">4.2.5</span> Hierarchical Task-Based Multithreading and Dynamic Scheduling</h3>
<p>The major change in Julia v1.3 is that Julia’s <code>Task</code>s, which are traditionally its green threads interface, are now the basis of its multithreading infrastructure. This means that all independent threads are parallelized, and a new interface for multithreading will exist that works by spawning threads.</p>
<p>This implementation follows Go’s goroutines and the classic multithreading interface of Cilk. There is a Julia-level scheduler that handles the multithreading to put different tasks on different vCPU threads. A benefit from this is hierarchical multithreading. Since Julia’s tasks can spawn tasks, what can happen is a task can create tasks which create tasks which etc. In Julia (/Go/Cilk), this is then seen as a single pool of tasks which it can schedule, and thus it will still make sure only <code>N</code> are running at a time (as opposed to the naive implementation where the total number of running threads is equal then multiplied). This is essential for numerical performance because running multiple compute threads on a single CPU thread requires constant context switching between the threads, which will slow down the computations.</p>
<p>To directly use the task-based interface, simply use <code>Threads.@spawn</code> to spawn new tasks. For example:</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">tmap2</span>(f,ps)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  tasks <span class="op">=</span> [<span class="bu">Threads</span>.<span class="pp">@spawn</span> <span class="fu">f</span>(ps[i]) for i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  out <span class="op">=</span> [<span class="fu">fetch</span>(t) for t <span class="kw">in</span> tasks]</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>threaded_out <span class="op">=</span> <span class="fu">tmap2</span>(p <span class="op">-&gt;</span> <span class="fu">compute_trajectory_mean5</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p),ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [1.2870613149922208, 1.1438117377304484, 22.669697978635234]
 [-0.097034701516529, -0.08504573089716216, 22.37001310300846]
 [0.27821116678919566, 0.27002118086184895, 12.235995564476475]
 [0.017555205468589588, 0.011991074160098073, 0.0005694144205018892]
 [2.9341064618083235, 2.957720277786962, 3.7631308833438184]
 [0.08355705930996428, 0.09868312584495192, 16.708323298061178]
 [0.1439809343709656, 0.1335020515226761, 26.897349357733248]
 [0.1645878209199906, 0.15892637778403598, 29.25441870590682]
 [0.023896881157504005, -0.013675090924136792, 7.4843300243334365]
 [4.106839222388996, 4.473461790124109, 7.9214466035819635]
 [-0.47550108258884005, -0.4860137926531155, 12.734635921351629]
 [5.440942288045614, 5.862161117104718, 23.130221311332342]
 [4.892880857532143, 5.275366330814495, 12.792226972706137]
 ⋮
 [0.6423401153616347, 0.7359944325332999, 23.732878946460538]
 [2.519234311063701, 2.529353415928587, 3.5827775800975536]
 [2.088308258334852, 2.1081397117252565, 2.9312902609659215]
 [2.442287584724364, 2.462780413293451, 4.902743083455716]
 [2.2888836655888816, 2.2957369635098184, 4.09734744761817]
 [3.0525482059827014, 3.0664148208970974, 4.531257717050107]
 [3.0198041858344693, 3.0717061281815505, 7.337327433546069]
 [3.7455104424898713, 3.7604129809004503, 5.631139370594428]
 [-3.7532028322749538, -3.783303266679652, 8.669842002760918]
 [0.16487278105552758, 0.15910352757025786, 12.675401664157413]
 [1.1817629127943725, 1.1832218915995645, 1.4615938649753042]
 [1.0866052697001025, 1.09106295335647, 4.324846322028256]</code></pre>
</div>
</div>
<p>However, if we check the timing we see:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">tmap2</span>(p <span class="op">-&gt;</span> <span class="fu">compute_trajectory_mean5</span>(<span class="pp">@SVector</span>([<span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>]),p),ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.763 ms (6005 allocations: 562.70 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>1000-element Vector{SVector{3, Float64}}:
 [1.2870613149922208, 1.1438117377304484, 22.669697978635234]
 [-0.097034701516529, -0.08504573089716216, 22.37001310300846]
 [0.27821116678919566, 0.27002118086184895, 12.235995564476475]
 [0.017555205468589588, 0.011991074160098073, 0.0005694144205018892]
 [2.9341064618083235, 2.957720277786962, 3.7631308833438184]
 [0.08355705930996428, 0.09868312584495192, 16.708323298061178]
 [0.1439809343709656, 0.1335020515226761, 26.897349357733248]
 [0.1645878209199906, 0.15892637778403598, 29.25441870590682]
 [0.023896881157504005, -0.013675090924136792, 7.4843300243334365]
 [4.106839222388996, 4.473461790124109, 7.9214466035819635]
 [-0.47550108258884005, -0.4860137926531155, 12.734635921351629]
 [5.440942288045614, 5.862161117104718, 23.130221311332342]
 [4.892880857532143, 5.275366330814495, 12.792226972706137]
 ⋮
 [0.6423401153616347, 0.7359944325332999, 23.732878946460538]
 [2.519234311063701, 2.529353415928587, 3.5827775800975536]
 [2.088308258334852, 2.1081397117252565, 2.9312902609659215]
 [2.442287584724364, 2.462780413293451, 4.902743083455716]
 [2.2888836655888816, 2.2957369635098184, 4.09734744761817]
 [3.0525482059827014, 3.0664148208970974, 4.531257717050107]
 [3.0198041858344693, 3.0717061281815505, 7.337327433546069]
 [3.7455104424898713, 3.7604129809004503, 5.631139370594428]
 [-3.7532028322749538, -3.783303266679652, 8.669842002760918]
 [0.16487278105552758, 0.15910352757025786, 12.675401664157413]
 [1.1817629127943725, 1.1832218915995645, 1.4615938649753042]
 [1.0866052697001025, 1.09106295335647, 4.324846322028256]</code></pre>
</div>
</div>
<p><code>Threads.@threads</code> is built on the same multithreading infrastructure, so why is this so much slower? The reason is because <code>Threads.@threads</code> employs <strong>static scheduling</strong> while <code>Threads.@spawn</code> is using <strong>dynamic scheduling</strong>. Dynamic scheduling is the model of allowing the runtime to determine the ordering and scheduling of processes, i.e.&nbsp;what tasks will run run where and when. Julia’s task-based multithreading system has a thread scheduler which will automatically do this for you in the background, but because this is done at runtime it will have overhead. Static scheduling is the model of pre-determining where and when tasks will run, instead of allowing this to be determined at runtime. <code>Threads.@threads</code> is “quasi-static” in the sense that it cuts the loop so that it spawns only as many tasks as there are threads, essentially assigning one thread for even chunks of the input data.</p>
<p>Does this lack of runtime overhead mean that static scheduling is “better”? No, it simply has trade-offs. Static scheduling assumes that the runtime of each block is the same. For this specific case where there are fixed number of loop iterations for the dynamical systems, we know that every <code>compute_trajectory_mean5</code> costs exactly the same, and thus this will be more efficient. However, There are many cases where this might not be efficient. For example:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sleepmap_static</span>()</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  out <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{Int}</span>(<span class="cn">undef</span>,<span class="fl">24</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">24</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span>(i<span class="op">/</span><span class="fl">10</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    out[i] <span class="op">=</span> i</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="fu">isleep</span>(i) <span class="op">=</span> (<span class="fu">sleep</span>(i<span class="op">/</span><span class="fl">10</span>);i)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sleepmap_spawn</span>()</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  tasks <span class="op">=</span> [<span class="bu">Threads</span>.<span class="pp">@spawn</span>(<span class="fu">isleep</span>(i)) for i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">24</span>]</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  out <span class="op">=</span> [<span class="fu">fetch</span>(t) for t <span class="kw">in</span> tasks]</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">sleepmap_static</span>()</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">sleepmap_spawn</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  30.032 s (1052 allocations: 30.67 KiB)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  2.402 s (313 allocations: 17.55 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>24-element Vector{Int64}:
  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24</code></pre>
</div>
</div>
<p>The reason why this occurs is because of how the static scheduling had chunked my calculation. On my computer:</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Threads</span>.<span class="fu">nthreads</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>1</code></pre>
</div>
</div>
<p>This means that there are 6 tasks that are created by <code>Threads.@threads</code>. The first takes:</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(i<span class="op">/</span><span class="fl">10</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>1.0</code></pre>
</div>
</div>
<p>1 second, while the next group takes longer, then the next, etc. while the last takes:</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(i<span class="op">/</span><span class="fl">10</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">21</span><span class="op">:</span><span class="fl">24</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>9.0</code></pre>
</div>
</div>
<p>9 seconds (which is precisely the result!). Thus by unevenly distributing the runtime, we run as fast as the slowest thread. However, dynamic scheduling allows new tasks to immediately run when another is finished, meaning that the in that case the shorter tasks tend to be piled together, causing a faster execution. Thus whether dynamic or static scheduling is beneficial is dependent on the problem and the implementation of the static schedule.</p>
<section id="possible-project" class="level4" data-number="4.2.5.1">
<h4 data-number="4.2.5.1" class="anchored" data-anchor-id="possible-project"><span class="header-section-number">4.2.5.1</span> Possible Project</h4>
<p>Note that this can extend to external library calls as well. <a href="https://github.com/JuliaMath/FFTW.jl/pull/105">FFTW.jl recently gained support for this</a>. A possible final project would be to do a similar change <a href="https://github.com/JuliaLang/julia/issues/32786">to OpenBLAS</a>.</p>
</section>
</section>
</section>
<section id="a-teaser-for-alternative-parallelism-models" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="a-teaser-for-alternative-parallelism-models"><span class="header-section-number">4.3</span> A Teaser for Alternative Parallelism Models</h2>
<section id="simplest-parallel-code" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="simplest-parallel-code"><span class="header-section-number">4.3.1</span> Simplest Parallel Code</h3>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> <span class="fu">rand</span>(<span class="fl">10000</span>,<span class="fl">10000</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> <span class="fu">rand</span>(<span class="fl">10000</span>,<span class="fl">10000</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>A<span class="op">*</span>B</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>10000×10000 Matrix{Float64}:
 2529.02  2525.04  2525.5   2523.41  …  2502.55  2491.57  2532.05  2527.85
 2490.83  2481.74  2493.91  2512.91     2482.09  2488.14  2486.98  2471.21
 2515.04  2502.64  2514.29  2511.42     2488.54  2488.75  2507.64  2512.36
 2503.85  2486.43  2481.52  2469.86     2485.5   2462.59  2491.61  2476.54
 2517.15  2497.31  2502.47  2514.01     2494.42  2475.74  2499.98  2503.78
 2518.94  2502.0   2504.1   2513.73  …  2503.59  2480.16  2513.11  2505.43
 2536.13  2531.77  2531.96  2560.98     2531.99  2503.31  2541.91  2520.26
 2524.15  2502.71  2527.27  2516.97     2493.25  2498.01  2500.6   2510.92
 2465.45  2468.05  2486.37  2477.11     2467.8   2470.96  2482.67  2461.55
 2484.35  2479.11  2476.05  2510.38     2474.17  2464.76  2477.68  2475.19
 2492.32  2485.88  2483.0   2490.94  …  2482.6   2472.82  2487.66  2486.47
 2528.0   2501.62  2510.88  2528.93     2496.21  2486.49  2508.73  2504.82
 2490.97  2482.01  2483.6   2476.63     2481.24  2452.17  2471.32  2469.44
    ⋮                                ⋱                             
 2494.77  2492.79  2500.69  2495.52     2473.33  2469.06  2503.87  2479.53
 2504.33  2484.09  2487.61  2500.92     2494.83  2468.28  2501.73  2487.18
 2512.03  2501.31  2507.81  2516.98  …  2493.84  2471.47  2506.51  2501.31
 2525.0   2495.28  2497.91  2510.05     2476.66  2475.31  2503.12  2483.54
 2498.65  2487.66  2484.11  2485.84     2482.62  2475.31  2483.04  2470.14
 2484.89  2461.14  2480.86  2476.08     2464.63  2445.52  2479.57  2482.56
 2480.27  2481.26  2493.57  2487.54     2483.09  2458.73  2501.45  2485.35
 2525.02  2514.33  2519.78  2516.64  …  2511.22  2480.74  2530.18  2505.86
 2545.12  2534.92  2533.85  2532.71     2526.29  2514.33  2528.7   2521.14
 2512.11  2516.87  2513.09  2512.33     2479.93  2491.69  2501.4   2504.96
 2505.0   2505.1   2492.63  2511.32     2493.35  2474.13  2509.69  2495.74
 2518.78  2500.49  2507.42  2525.53     2496.14  2493.69  2506.43  2509.91</code></pre>
</div>
</div>
<p>If you are using a computer that has N cores, then this will use N cores. Try it and look at your resource usage!</p>
</section>
<section id="array-based-parallelism" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="array-based-parallelism"><span class="header-section-number">4.3.2</span> Array-Based Parallelism</h3>
<p>The simplest form of parallelism is array-based parallelism. The idea is that you use some construction of an array whose operations are already designed to be parallel under the hood. In Julia, some examples of this are:</p>
<ul>
<li>DistributedArrays (Distributed Computing)</li>
<li>Elemental</li>
<li>MPIArrays</li>
<li>CuArrays (GPUs)</li>
</ul>
<p>This is not a Julia specific idea either.</p>
</section>
<section id="blas-and-standard-libraries" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="blas-and-standard-libraries"><span class="header-section-number">4.3.3</span> BLAS and Standard Libraries</h3>
<p>The basic linear algebra calls are all handled by a set of libraries which follow the same interface known as BLAS (Basic Linear Algebra Subroutines). It’s divided into 3 portions:</p>
<ul>
<li>BLAS1: Element-wise operations (O(n))</li>
<li>BLAS2: Matrix-vector operations (O(n^2))</li>
<li>BLAS3: Matrix-matrix operations (O(n^3))</li>
</ul>
<p>BLAS implementations are highly optimized, like OpenBLAS and Intel MKL, so every numerical language and library essentially uses similar underlying BLAS implementations. Extensions to these, known as LAPACK, include operations like factorizations, and are included in these standard libraries. These are all multithreaded. The reason why this is a location to target is because the operation count is high enough that parallelism can be made efficient even when only targeting this level: a matrix multiplication can take on the order of seconds, minutes, hours, or even days, and these are all highly parallel operations. This means you can get away with a bunch just by parallelizing at this level, which happens to be a bottleneck for a lot scientific computing codes.</p>
<p>This is also commonly the level at which GPU computing occurs in machine learning libraries for reasons which we will explain later.</p>
</section>
<section id="mpi" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="mpi"><span class="header-section-number">4.3.4</span> MPI</h3>
<p>Well, this is a big topic and we’ll address this one later!</p>
</section>
</section>
<section id="conclusion" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">4.4</span> Conclusion</h2>
<p>The easiest forms of parallelism are:</p>
<ul>
<li>Embarrassingly parallel</li>
<li>Array-level parallelism (built into linear algebra)</li>
</ul>
<p>Exploit these when possible.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./dynamical_systems.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">How Loops Work, An Introduction to Discrete Dynamics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./styles_of_parallelism.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Different Flavors of Parallelism</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>