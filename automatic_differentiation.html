<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MIT Parallel Computing and Scientific Machine Learning - 7&nbsp; Forward-Mode Automatic Differentiation (AD) via High Dimensional Algebras</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./stiff_odes.html" rel="next">
<link href="./discretizing_odes.html" rel="prev">
<link href="./sciml-book-logo.svg" rel="icon" type="image/svg+xml">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./automatic_differentiation.html">Modern Approaches</a></li><li class="breadcrumb-item"><a href="./automatic_differentiation.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Forward-Mode Automatic Differentiation (AD) via High Dimensional Algebras</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./sciml-book-logo.svg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">MIT Parallel Computing and Scientific Machine Learning</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/jvaverka/SciMLBook" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./MIT-Parallel-Computing-and-Scientific-Machine-Learning.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./MIT-Parallel-Computing-and-Scientific-Machine-Learning.epub">
              <i class="bi bi-bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Parallel Computing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Optimizing Serial Code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sciml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to Scientific Machine Learning through Physics-Informed Neural Networks</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Parallel Computing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dynamical_systems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">How Loops Work, An Introduction to Discrete Dynamics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parallelism_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Basics of Single Node Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./styles_of_parallelism.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Different Flavors of Parallelism</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discretizing_odes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Ordinary Differential Equations, Applications and Discretizations</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Modern Approaches</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./automatic_differentiation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Forward-Mode Automatic Differentiation (AD) via High Dimensional Algebras</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stiff_odes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Solving Stiff Ordinary Differential Equations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimation_identification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Basic Parameter Estimation, Reverse-Mode AD, and Inverse Problems</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./adjoints.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Differentiable Programming and Neural Differential Equations</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Modern Architectures</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mpi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Introduction to MPI.jl</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gpus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">GPU programming</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Advanced Differential Equations</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pdes_and_convolutions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">PDEs, Convolutions, and the Mathematics of Locality</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diffeq_machine_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Mixing Differential Equations and Neural Networks for Physics-Informed Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probabilistic_programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">From Optimization to Probabilistic Programming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./global_sensitivity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Global Sensitivity Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./profiling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Code Profiling and Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Uncertainty Programming, Generalized Uncertainty Quantification</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#youtube-video-link" id="toc-youtube-video-link" class="nav-link active" data-scroll-target="#youtube-video-link"><span class="header-section-number">7.1</span> Youtube Video Link</a></li>
  <li><a href="#machine-epsilon-and-roundoff-error" id="toc-machine-epsilon-and-roundoff-error" class="nav-link" data-scroll-target="#machine-epsilon-and-roundoff-error"><span class="header-section-number">7.2</span> Machine Epsilon and Roundoff Error</a>
  <ul class="collapse">
  <li><a href="#finite-differencing-and-numerical-stability" id="toc-finite-differencing-and-numerical-stability" class="nav-link" data-scroll-target="#finite-differencing-and-numerical-stability"><span class="header-section-number">7.2.1</span> Finite Differencing and Numerical Stability</a></li>
  <li><a href="#differencing-in-a-different-dimension-complex-step-differentiation" id="toc-differencing-in-a-different-dimension-complex-step-differentiation" class="nav-link" data-scroll-target="#differencing-in-a-different-dimension-complex-step-differentiation"><span class="header-section-number">7.2.2</span> Differencing in a Different Dimension: Complex Step Differentiation</a></li>
  <li><a href="#derivatives-as-nilpotent-sensitivities" id="toc-derivatives-as-nilpotent-sensitivities" class="nav-link" data-scroll-target="#derivatives-as-nilpotent-sensitivities"><span class="header-section-number">7.2.3</span> Derivatives as nilpotent sensitivities</a></li>
  <li><a href="#dual-numbers" id="toc-dual-numbers" class="nav-link" data-scroll-target="#dual-numbers"><span class="header-section-number">7.2.4</span> Dual numbers</a></li>
  <li><a href="#computer-representation" id="toc-computer-representation" class="nav-link" data-scroll-target="#computer-representation"><span class="header-section-number">7.2.5</span> Computer representation</a></li>
  <li><a href="#performance" id="toc-performance" class="nav-link" data-scroll-target="#performance"><span class="header-section-number">7.2.6</span> Performance</a></li>
  <li><a href="#defining-higher-order-primitives" id="toc-defining-higher-order-primitives" class="nav-link" data-scroll-target="#defining-higher-order-primitives"><span class="header-section-number">7.2.7</span> Defining Higher Order Primitives</a></li>
  </ul></li>
  <li><a href="#differentiating-arbitrary-functions" id="toc-differentiating-arbitrary-functions" class="nav-link" data-scroll-target="#differentiating-arbitrary-functions"><span class="header-section-number">7.3</span> Differentiating arbitrary functions</a>
  <ul class="collapse">
  <li><a href="#higher-dimensions" id="toc-higher-dimensions" class="nav-link" data-scroll-target="#higher-dimensions"><span class="header-section-number">7.3.1</span> Higher dimensions</a></li>
  <li><a href="#implementation-of-higher-dimensional-forward-mode-ad" id="toc-implementation-of-higher-dimensional-forward-mode-ad" class="nav-link" data-scroll-target="#implementation-of-higher-dimensional-forward-mode-ad"><span class="header-section-number">7.3.2</span> Implementation of higher-dimensional forward-mode AD</a></li>
  <li><a href="#directional-derivative-and-gradient-of-functions-f-mathbbrn-to-mathbbr" id="toc-directional-derivative-and-gradient-of-functions-f-mathbbrn-to-mathbbr" class="nav-link" data-scroll-target="#directional-derivative-and-gradient-of-functions-f-mathbbrn-to-mathbbr"><span class="header-section-number">7.3.3</span> Directional derivative and gradient of functions <span class="math inline">\(f: \mathbb{R}^n \to \mathbb{R}\)</span></a></li>
  <li><a href="#forward-mode-ad-as-jvp" id="toc-forward-mode-ad-as-jvp" class="nav-link" data-scroll-target="#forward-mode-ad-as-jvp"><span class="header-section-number">7.3.4</span> Forward-Mode AD as jvp</a></li>
  <li><a href="#jacobian" id="toc-jacobian" class="nav-link" data-scroll-target="#jacobian"><span class="header-section-number">7.3.5</span> Jacobian</a></li>
  <li><a href="#array-of-structs-representation" id="toc-array-of-structs-representation" class="nav-link" data-scroll-target="#array-of-structs-representation"><span class="header-section-number">7.3.6</span> Array of Structs Representation</a></li>
  <li><a href="#higher-derivatives" id="toc-higher-derivatives" class="nav-link" data-scroll-target="#higher-derivatives"><span class="header-section-number">7.3.7</span> Higher derivatives</a></li>
  </ul></li>
  <li><a href="#application-solving-nonlinear-equations-using-the-newton-method" id="toc-application-solving-nonlinear-equations-using-the-newton-method" class="nav-link" data-scroll-target="#application-solving-nonlinear-equations-using-the-newton-method"><span class="header-section-number">7.4</span> Application: solving nonlinear equations using the Newton method</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">7.5</span> Conclusion</a>
  <ul class="collapse">
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">7.5.1</span> References</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/jvaverka/SciMLBook/edit/main/automatic_differentiation.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/jvaverka/SciMLBook/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/jvaverka/SciMLBook/blob/main/automatic_differentiation.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Forward-Mode Automatic Differentiation (AD) via High Dimensional Algebras</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="youtube-video-link" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="youtube-video-link"><span class="header-section-number">7.1</span> <a href="https://youtu.be/zHPXGBiTM5A">Youtube Video Link</a></h2>
</section>
<section id="machine-epsilon-and-roundoff-error" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="machine-epsilon-and-roundoff-error"><span class="header-section-number">7.2</span> Machine Epsilon and Roundoff Error</h2>
<p>Floating point arithmetic is relatively scaled, which means that the precision that you get from calculations is relative to the size of the floating point numbers. Generally, you have 16 digits of accuracy in (64-bit) floating point operations. To measure this, we define <em>machine epsilon</em> as the value by which <code>1 + E = 1</code>. For floating point numbers, this is:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eps</span>(<span class="dt">Float64</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>2.220446049250313e-16</code></pre>
</div>
</div>
<p>However, since it’s relative, this value changes as we change our reference value:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> <span class="fu">eps</span>(<span class="fl">1.0</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> <span class="fu">eps</span>(<span class="fl">0.1</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> <span class="fu">eps</span>(<span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>eps(1.0) = 2.220446049250313e-16
eps(0.1) = 1.3877787807814457e-17
eps(0.01) = 1.734723475976807e-18</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>1.734723475976807e-18</code></pre>
</div>
</div>
<p>Thus issues with <em>roundoff error</em> come when one subtracts out the higher digits. For example, <span class="math inline">\((x + \epsilon) - x\)</span> should just be <span class="math inline">\(\epsilon\)</span> if there was no roundoff error, but if <span class="math inline">\(\epsilon\)</span> is small then this kicks in. If <span class="math inline">\(x = 1\)</span> and <span class="math inline">\(\epsilon\)</span> is of size around <span class="math inline">\(10^{-10}\)</span>, then <span class="math inline">\(x+ \epsilon\)</span> is correct for 10 digits, dropping off the smallest 6 due to error in the addition to <span class="math inline">\(1\)</span>. But when you subtract off <span class="math inline">\(x\)</span>, you don’t get those digits back, and thus you only have 6 digits of <span class="math inline">\(\epsilon\)</span> correct.</p>
<p>Let’s see this in action:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ϵ <span class="op">=</span> <span class="fl">1e-10</span><span class="fu">rand</span>()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> ϵ</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> (<span class="fl">1</span><span class="op">+</span>ϵ)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>ϵ<span class="fl">2</span> <span class="op">=</span> (<span class="fl">1</span><span class="op">+</span>ϵ) <span class="op">-</span> <span class="fl">1</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>(ϵ <span class="op">-</span> ϵ<span class="fl">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ϵ = 8.077473707516503e-12
1 + ϵ = 1.0000000000080775</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>-6.493044628591267e-17</code></pre>
</div>
</div>
<p>See how <span class="math inline">\(\epsilon\)</span> is only rebuilt at accuracy around <span class="math inline">\(10^{-16}\)</span> and thus we only keep around 6 digits of accuracy when it’s generated at the size of around <span class="math inline">\(10^{-10}\)</span>!</p>
<section id="finite-differencing-and-numerical-stability" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="finite-differencing-and-numerical-stability"><span class="header-section-number">7.2.1</span> Finite Differencing and Numerical Stability</h3>
<p>To start understanding how to compute derivatives on a computer, we start with <em>finite differencing</em>. For finite differencing, recall that the definition of the derivative is:</p>
<p><span class="math display">\[f'(x) = \lim_{\epsilon \rightarrow 0} \frac{f(x+\epsilon)-f(x)}{\epsilon}\]</span></p>
<p>Finite differencing directly follows from this definition by choosing a small <span class="math inline">\(\epsilon\)</span>. However, choosing a good <span class="math inline">\(\epsilon\)</span> is very difficult. If <span class="math inline">\(\epsilon\)</span> is too large than there is error since this definition is asymptotic. However, if <span class="math inline">\(\epsilon\)</span> is too small, you receive roundoff error. To understand why you would get roundoff error, recall that floating point error is relative, and can essentially store 16 digits of accuracy. So let’s say we choose <span class="math inline">\(\epsilon = 10^{-6}\)</span>. Then <span class="math inline">\(f(x+\epsilon) - f(x)\)</span> is roughly the same in the first 6 digits, meaning that after the subtraction there is only 10 digits of accuracy, and then dividing by <span class="math inline">\(10^{-6}\)</span> simply brings those 10 digits back up to the correct relative size.</p>
<p><img src="https://www.researchgate.net/profile/Jongrae_Kim/publication/267216155/figure/fig1/AS:651888458493955@1532433728729/Finite-Difference-Error-Versus-Step-Size.png" class="img-fluid"></p>
<p>This means that we want to choose <span class="math inline">\(\epsilon\)</span> small enough that the <span class="math inline">\(\mathcal{O}(\epsilon^2)\)</span> error of the truncation is balanced by the <span class="math inline">\(O(1/\epsilon)\)</span> roundoff error. Under some minor assumptions, one can argue that the average best point is <span class="math inline">\(\sqrt(E)\)</span>, where E is machine epsilon</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> <span class="fu">eps</span>(<span class="dt">Float64</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> <span class="fu">sqrt</span>(<span class="fu">eps</span>(<span class="dt">Float64</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>eps(Float64) = 2.220446049250313e-16
sqrt(eps(Float64)) = 1.4901161193847656e-8</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>1.4901161193847656e-8</code></pre>
</div>
</div>
<p>This means we should not expect better than 8 digits of accuracy, even when things are good with finite differencing.</p>
<p><img src="http://degenerateconic.com/wp-content/uploads/2014/11/complex_step1.png" class="img-fluid"></p>
<p>The centered difference formula is a little bit better, but this picture suggests something much better…</p>
</section>
<section id="differencing-in-a-different-dimension-complex-step-differentiation" class="level3" data-number="7.2.2">
<h3 data-number="7.2.2" class="anchored" data-anchor-id="differencing-in-a-different-dimension-complex-step-differentiation"><span class="header-section-number">7.2.2</span> Differencing in a Different Dimension: Complex Step Differentiation</h3>
<p>The problem with finite differencing is that we are mixing our really small number with the really large number, and so when we do the subtract we lose accuracy. Instead, we want to keep the small perturbation completely separate.</p>
<p>To see how to do this, assume that <span class="math inline">\(x \in \mathbb{R}\)</span> and assume that <span class="math inline">\(f\)</span> is complex analytic. You want to calculate a real derivative, but your function just happens to also be complex analytic when extended to the complex plane. Thus it has a Taylor series, and let’s see what happens when we expand out this Taylor series purely in the complex direction:</p>
<p><span class="math display">\[f(x+ih) = f(x) + f'(x)ih - \frac{1}{2}f''(x)h^2 + \mathcal{O}(h^3)\]</span></p>
<p>which we can re-arrange as:</p>
<p><span class="math display">\[if'(x) = \frac{f(x+ih) - f(x)}{h} + \frac{1}{2}f''(x)h + \mathcal{O}(h^2)\]</span></p>
<p>Since <span class="math inline">\(x\)</span> is real and <span class="math inline">\(f\)</span> is real-valued on the reals, <span class="math inline">\(if'\)</span> is purely imaginary. So let’s take the imaginary parts of both sides:</p>
<p><span class="math display">\[f'(x) = \frac{Im(f(x+ih))}{h} + \mathcal{O}(h^2)\]</span></p>
<p>since <span class="math inline">\(Im(f(x)) = 0\)</span> (since it’s real valued, the next order term cancels for the same reason). Thus with a sufficiently small choice of <span class="math inline">\(h\)</span>, this is the <em>complex step differentiation</em> formula for calculating the derivative.</p>
<p>But to understand the computational advantage, recall that <span class="math inline">\(x\)</span> is pure real, and thus <span class="math inline">\(x+ih\)</span> is a complex number where <strong>the <span class="math inline">\(h\)</span> never directly interacts with <span class="math inline">\(x\)</span></strong> since a complex number is a two dimensional number where you keep the two pieces separate. Thus there is no numerical cancellation by using a small value of <span class="math inline">\(h\)</span>, and thus, due to the relative precision of floating point numbers, both the real and imaginary parts will be computed to (approximately) 16 digits of accuracy for any choice of <span class="math inline">\(h\)</span>.</p>
</section>
<section id="derivatives-as-nilpotent-sensitivities" class="level3" data-number="7.2.3">
<h3 data-number="7.2.3" class="anchored" data-anchor-id="derivatives-as-nilpotent-sensitivities"><span class="header-section-number">7.2.3</span> Derivatives as nilpotent sensitivities</h3>
<p>The derivative measures the <strong>sensitivity</strong> of a function, i.e.&nbsp;how much the function output changes when the input changes by a small amount <span class="math inline">\(\epsilon\)</span>:</p>
<p><span class="math display">\[f(a + \epsilon) = f(a) + f'(a) \epsilon + o(\epsilon).\]</span></p>
<p>In the following we will ignore higher-order terms; formally we set <span class="math inline">\(\epsilon^2 = 0\)</span>. This form of analysis can be made rigorous through a form of non-standard analysis called <em>Smooth Infinitesimal Analysis</em> [1], though note that nilpotent infinitesimal requires <em>constructive logic</em>, and thus proof by contradiction is not allowed in this logic due to a lack of the <em>law of the excluded middle</em>.</p>
<p>A function <span class="math inline">\(f\)</span> will be represented by its value <span class="math inline">\(f(a)\)</span> and derivative <span class="math inline">\(f'(a)\)</span>, encoded as the coefficients of a degree-1 (Taylor) polynomial in <span class="math inline">\(\epsilon\)</span>:</p>
<p><span class="math display">\[f \rightsquigarrow f(a) + \epsilon f'(a)\]</span></p>
<p>Conversely, if we have such an expansion in <span class="math inline">\(\epsilon\)</span> for a given function <span class="math inline">\(f\)</span>, then we can identify the coefficient of <span class="math inline">\(\epsilon\)</span> as the derivative of <span class="math inline">\(f\)</span>.</p>
</section>
<section id="dual-numbers" class="level3" data-number="7.2.4">
<h3 data-number="7.2.4" class="anchored" data-anchor-id="dual-numbers"><span class="header-section-number">7.2.4</span> Dual numbers</h3>
<p>Thus, to extend the idea of complex step differentiation beyond complex analytic functions, we define a new number type, the <em>dual number</em>. A dual number is a multidimensional number where the sensitivity of the function is propagated along the dual portion.</p>
<p>Here we will now start to use <span class="math inline">\(\epsilon\)</span> as a dimensional signifier, like <span class="math inline">\(i\)</span>, <span class="math inline">\(j\)</span>, or <span class="math inline">\(k\)</span> for quaternion numbers. In order for this to work out, we need to derive an appropriate algebra for our numbers. To do this, we will look at Taylor series to make our algebra reconstruct differentiation.</p>
<p>Note that the chain rule has been explicitly encoded in the derivative part.</p>
<p><span class="math display">\[f(a + \epsilon) = f(a) + \epsilon f'(a)\]</span></p>
<p>to first order. If we have two functions</p>
<p><span class="math display">\[f \rightsquigarrow f(a) + \epsilon f'(a)\]</span> <span class="math display">\[g \rightsquigarrow g(a) + \epsilon g'(a)\]</span></p>
<p>then we can manipulate these Taylor expansions to calculate combinations of these functions as follows. Using the nilpotent algebra, we have that:</p>
<p><span class="math display">\[(f + g) = [f(a) + g(a)] + \epsilon[f'(a) + g'(a)]\]</span></p>
<p><span class="math display">\[(f \cdot g) = [f(a) \cdot g(a)] + \epsilon[f(a) \cdot g'(a) + g(a) \cdot f'(a) ]\]</span></p>
<p>From these we can <em>infer</em> the derivatives by taking the component of <span class="math inline">\(\epsilon\)</span>. These also tell us the way to implement these in the computer.</p>
</section>
<section id="computer-representation" class="level3" data-number="7.2.5">
<h3 data-number="7.2.5" class="anchored" data-anchor-id="computer-representation"><span class="header-section-number">7.2.5</span> Computer representation</h3>
<p>Setup (not necessary from the REPL):</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">InteractiveUtils  </span><span class="co"># only needed when using Weave</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each function requires two pieces of information and some particular “behavior”, so we store these in a <code>struct</code>. It’s common to call this a “dual number”:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Dual{T}</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    val<span class="op">::</span><span class="dt">T   </span><span class="co"># value</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    der<span class="op">::</span><span class="dt">T  </span><span class="co"># derivative</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each <code>Dual</code> object represents a function. We define arithmetic operations to mirror performing those operations on the corresponding functions.</p>
<p>We must first import the operations from <code>Base</code>:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">+</span>(f<span class="op">::</span><span class="dt">Dual</span>, g<span class="op">::</span><span class="dt">Dual</span>) <span class="op">=</span> <span class="fu">Dual</span>(f.val <span class="op">+</span> g.val, f.der <span class="op">+</span> g.der)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">+</span>(f<span class="op">::</span><span class="dt">Dual</span>, α<span class="op">::</span><span class="dt">Number</span>) <span class="op">=</span> <span class="fu">Dual</span>(f.val <span class="op">+</span> α, f.der)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">+</span>(α<span class="op">::</span><span class="dt">Number</span>, f<span class="op">::</span><span class="dt">Dual</span>) <span class="op">=</span> f <span class="op">+</span> α</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">#=</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">You can also write:</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">import Base: +</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">f::Dual + g::Dual = Dual(f.val + g.val, f.der + g.der)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">=#</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">-</span>(f<span class="op">::</span><span class="dt">Dual</span>, g<span class="op">::</span><span class="dt">Dual</span>) <span class="op">=</span> <span class="fu">Dual</span>(f.val <span class="op">-</span> g.val, f.der <span class="op">-</span> g.der)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Product Rule</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(f<span class="op">::</span><span class="dt">Dual</span>, g<span class="op">::</span><span class="dt">Dual</span>) <span class="op">=</span> <span class="fu">Dual</span>(f.val<span class="op">*</span>g.val, f.der<span class="op">*</span>g.val <span class="op">+</span> f.val<span class="op">*</span>g.der)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(α<span class="op">::</span><span class="dt">Number</span>, f<span class="op">::</span><span class="dt">Dual</span>) <span class="op">=</span> <span class="fu">Dual</span>(f.val <span class="op">*</span> α, f.der <span class="op">*</span> α)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(f<span class="op">::</span><span class="dt">Dual</span>, α<span class="op">::</span><span class="dt">Number</span>) <span class="op">=</span> α <span class="op">*</span> f</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Quotient Rule</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:/</span>(f<span class="op">::</span><span class="dt">Dual</span>, g<span class="op">::</span><span class="dt">Dual</span>) <span class="op">=</span> <span class="fu">Dual</span>(f.val<span class="op">/</span>g.val, (f.der<span class="op">*</span>g.val <span class="op">-</span> f.val<span class="op">*</span>g.der)<span class="op">/</span>(g.val<span class="op">^</span><span class="fl">2</span>))</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:/</span>(α<span class="op">::</span><span class="dt">Number</span>, f<span class="op">::</span><span class="dt">Dual</span>) <span class="op">=</span> <span class="fu">Dual</span>(α<span class="op">/</span>f.val, <span class="op">-</span>α<span class="op">*</span>f.der<span class="op">/</span>f.val<span class="op">^</span><span class="fl">2</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:/</span>(f<span class="op">::</span><span class="dt">Dual</span>, α<span class="op">::</span><span class="dt">Number</span>) <span class="op">=</span> f <span class="op">*</span> <span class="fu">inv</span>(α) <span class="co"># Dual(f.val/α, f.der * (1/α))</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:^</span>(f<span class="op">::</span><span class="dt">Dual</span>, n<span class="op">::</span><span class="dt">Integer</span>) <span class="op">=</span> <span class="bu">Base</span>.<span class="fu">power_by_squaring</span>(f, n)  <span class="co"># use repeated squaring for integer powers</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now define <code>Dual</code>s and manipulate them:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fd <span class="op">=</span> <span class="fu">Dual</span>(<span class="fl">3</span>, <span class="fl">4</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>gd <span class="op">=</span> <span class="fu">Dual</span>(<span class="fl">5</span>, <span class="fl">6</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>fd <span class="op">+</span> gd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>Dual{Int64}(8, 10)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fd <span class="op">*</span> gd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Dual{Int64}(15, 38)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fd <span class="op">*</span> (gd <span class="op">+</span> gd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>Dual{Int64}(30, 76)</code></pre>
</div>
</div>
</section>
<section id="performance" class="level3" data-number="7.2.6">
<h3 data-number="7.2.6" class="anchored" data-anchor-id="performance"><span class="header-section-number">7.2.6</span> Performance</h3>
<p>It seems like we may have introduced significant computational overhead by creating a new data structure, and associated methods. Let’s see how the performance is:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span>(a1, a2, b1, b2) <span class="op">=</span> (a1<span class="op">+</span>b1, a2<span class="op">+</span>b2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>add (generic function with 1 method)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>a, b, c, d <span class="op">=</span> <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">add</span>(<span class="op">$</span>(<span class="fu">Ref</span>(a))[], <span class="op">$</span>(<span class="fu">Ref</span>(b))[], <span class="op">$</span>(<span class="fu">Ref</span>(c))[], <span class="op">$</span>(<span class="fu">Ref</span>(d))[])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  2.730 ns (0 allocations: 0 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>(4, 6)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">Dual</span>(<span class="fl">1</span>, <span class="fl">2</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="fu">Dual</span>(<span class="fl">3</span>, <span class="fl">4</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span>(j1, j2) <span class="op">=</span> j1 <span class="op">+</span> j2</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span>(a, b)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">add</span>(<span class="op">$</span>(<span class="fu">Ref</span>(a))[], <span class="op">$</span>(<span class="fu">Ref</span>(b))[])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  2.924 ns (0 allocations: 0 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>Dual{Int64}(4, 6)</code></pre>
</div>
</div>
<p>It seems like we have lost <em>no</em> performance.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@code_native</span> <span class="fu">add</span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>.text
    .file   "add"
    .globl  julia_add_1491                  # -- Begin function julia_add_1491
    .p2align    4, 0x90
    .type   julia_add_1491,@function
julia_add_1491:                         # @julia_add_1491
; ┌ @ In[13]:1 within `add`
    .cfi_startproc
# %bb.0:                                # %top
    pushq   %rbp
    .cfi_def_cfa_offset 16
    .cfi_offset %rbp, -16
    movq    %rsp, %rbp
    .cfi_def_cfa_register %rbp
    movq    %rdi, %rax
; │┌ @ int.jl:87 within `+`
    addq    %rcx, %rsi
    addq    %r8, %rdx
; │└
    movq    %rsi, (%rdi)
    movq    %rdx, 8(%rdi)
    popq    %rbp
    .cfi_def_cfa %rsp, 8
    retq
.Lfunc_end0:
    .size   julia_add_1491, .Lfunc_end0-julia_add_1491
    .cfi_endproc
; └
                                        # -- End function
    .section    ".note.GNU-stack","",@progbits</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@code_native</span> <span class="fu">add</span>(a, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    .text
    .file   "add"
    .globl  julia_add_1514                  # -- Begin function julia_add_1514
    .p2align    4, 0x90
    .type   julia_add_1514,@function
julia_add_1514:                         # @julia_add_1514
; ┌ @ In[15]:4 within `add`
    .cfi_startproc
# %bb.0:                                # %top
    pushq   %rbp
    .cfi_def_cfa_offset 16
    .cfi_offset %rbp, -16
    movq    %rsp, %rbp
    .cfi_def_cfa_register %rbp
    movq    %rdi, %rax
; │┌ @ In[9]:1 within `+` @ int.jl:87
    vmovdqu (%rdx), %xmm0
    vpaddq  (%rsi), %xmm0, %xmm0
; │└
    vmovdqu %xmm0, (%rdi)
    popq    %rbp
    .cfi_def_cfa %rsp, 8
    retq
.Lfunc_end0:
    .size   julia_add_1514, .Lfunc_end0-julia_add_1514
    .cfi_endproc
; └
                                        # -- End function
    .section    ".note.GNU-stack","",@progbits</code></pre>
</div>
</div>
<p>We see that the data structure itself has disappeared, and we basically have a standard Julia tuple.</p>
</section>
<section id="defining-higher-order-primitives" class="level3" data-number="7.2.7">
<h3 data-number="7.2.7" class="anchored" data-anchor-id="defining-higher-order-primitives"><span class="header-section-number">7.2.7</span> Defining Higher Order Primitives</h3>
<p>We can also define functions of <code>Dual</code> objects, using the chain rule. To speed up our derivative function, we can directly hardcode the derivative of known functions which we call <em>primitives</em>. If <code>f</code> is a <code>Dual</code> representing the function <span class="math inline">\(f\)</span>, then <code>exp(f)</code> should be a <code>Dual</code> representing the function <span class="math inline">\(\exp \circ f\)</span>, i.e.&nbsp;with value <span class="math inline">\(\exp(f(a))\)</span> and derivative <span class="math inline">\((\exp \circ f)'(a) = \exp(f(a)) \, f'(a)\)</span>:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Base</span>: exp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(f<span class="op">::</span><span class="dt">Dual</span>) <span class="op">=</span> <span class="fu">Dual</span>(<span class="fu">exp</span>(f.val), <span class="fu">exp</span>(f.val) <span class="op">*</span> f.der)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>exp (generic function with 14 methods)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>Dual{Int64}(3, 4)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(fd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>Dual{Float64}(20.085536923187668, 80.34214769275067)</code></pre>
</div>
</div>
</section>
</section>
<section id="differentiating-arbitrary-functions" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="differentiating-arbitrary-functions"><span class="header-section-number">7.3</span> Differentiating arbitrary functions</h2>
<p>For functions where we don’t have a rule, we can recursively do dual number arithmetic within the function until we hit primitives where we know the derivative, and then use the chain rule to propagate the information back up. Under this algebra, we can represent <span class="math inline">\(a + \epsilon\)</span> as <code>Dual(a, 1)</code>. Thus, applying <code>f</code> to <code>Dual(a, 1)</code> should give <code>Dual(f(a), f'(a))</code>. This is thus a 2-dimensional number for calculating the derivative without floating point error, <strong>using the compiler to transform our equations into dual number arithmetic</strong>. To differentiate an arbitrary function, we define a generic function and then change the algebra.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hf</span>(x) <span class="op">=</span> x<span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">2</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fl">3</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>xx <span class="op">=</span> <span class="fu">Dual</span>(a, <span class="fl">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>Dual{Int64}(3, 1)</code></pre>
</div>
</div>
<p>Now we simply evaluate the function <code>h</code> at the <code>Dual</code> number <code>xx</code>:</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hf</span>(xx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>Dual{Int64}(11, 6)</code></pre>
</div>
</div>
<p>The first component of the resulting <code>Dual</code> is the value <span class="math inline">\(h(a)\)</span>, and the second component is the derivative, <span class="math inline">\(h'(a)\)</span>!</p>
<p>We can codify this into a function as follows:</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">derivative</span>(f, x) <span class="op">=</span> <span class="fu">f</span>(<span class="fu">Dual</span>(x, <span class="fu">one</span>(x))).der</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>derivative (generic function with 1 method)</code></pre>
</div>
</div>
<p>Here, <code>one</code> is the function that gives the value <span class="math inline">\(1\)</span> with the same type as that of <code>x</code>.</p>
<p>Finally we can now calculate derivatives such as</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">derivative</span>(x <span class="op">-&gt;</span> <span class="fl">3</span>x<span class="op">^</span><span class="fl">5</span> <span class="op">+</span> <span class="fl">2</span>, <span class="fl">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>240</code></pre>
</div>
</div>
<p>As a bigger example, we can take a pure Julia <code>sqrt</code> function and differentiate it by changing the internal algebra:</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">newtons</span>(x)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>   a <span class="op">=</span> x</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">300</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>       a <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (a <span class="op">+</span> x<span class="op">/</span>a)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>   a</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> <span class="fu">newtons</span>(<span class="fl">2.0</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="pp">@show</span> (<span class="fu">newtons</span>(<span class="fl">2.0</span><span class="fu">+sqrt</span>(<span class="fu">eps</span>())) <span class="op">-</span> <span class="fu">newtons</span>(<span class="fl">2.0</span>))<span class="op">/</span> <span class="fu">sqrt</span>(<span class="fu">eps</span>())</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="fu">newtons</span>(<span class="fu">Dual</span>(<span class="fl">2.0</span>,<span class="fl">1.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>newtons(2.0) = 1.414213562373095
(newtons(2.0 + sqrt(eps())) - newtons(2.0)) / sqrt(eps()) = 0.3535533994436264</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>Dual{Float64}(1.414213562373095, 0.35355339059327373)</code></pre>
</div>
</div>
<section id="higher-dimensions" class="level3" data-number="7.3.1">
<h3 data-number="7.3.1" class="anchored" data-anchor-id="higher-dimensions"><span class="header-section-number">7.3.1</span> Higher dimensions</h3>
<p>How can we extend this to higher dimensional functions? For example, we wish to differentiate the following function <span class="math inline">\(f: \mathbb{R}^2 \to \mathbb{R}\)</span>:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fquad</span>(x, y) <span class="op">=</span> x<span class="op">^</span><span class="fl">2</span> <span class="op">+</span> x<span class="op">*</span>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>fquad (generic function with 1 method)</code></pre>
</div>
</div>
<p>Recall that the <strong>partial derivative</strong> <span class="math inline">\(\partial f/\partial x\)</span> is defined by fixing <span class="math inline">\(y\)</span> and differentiating the resulting function of <span class="math inline">\(x\)</span>:</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>a, b <span class="op">=</span> <span class="fl">3.0</span>, <span class="fl">4.0</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fquad_1</span>(x) <span class="op">=</span> <span class="fu">fquad</span>(x, b)  <span class="co"># single-variable function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>fquad_1 (generic function with 1 method)</code></pre>
</div>
</div>
<p>Since we now have a single-variable function, we can differentiate it:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">derivative</span>(fquad_1, a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>10.0</code></pre>
</div>
</div>
<p>Under the hood this is doing</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fquad</span>(<span class="fu">Dual</span>(a, <span class="fu">one</span>(a)), b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>Dual{Float64}(21.0, 10.0)</code></pre>
</div>
</div>
<p>Similarly, we can differentiate with respect to <span class="math inline">\(y\)</span> by doing</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fquad_2</span>(y) <span class="op">=</span> <span class="fu">fquad</span>(a, y)  <span class="co"># single-variable function</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">derivative</span>(fquad_2, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>3.0</code></pre>
</div>
</div>
<p>Note that we must do <strong>two separate calculations</strong> to get the two partial derivatives; in general, calculating the gradient <span class="math inline">\(\nabla\)</span> of a function <span class="math inline">\(f:\mathbb{R}^n \to \mathbb{R}\)</span> requires <span class="math inline">\(n\)</span> separate calculations.</p>
</section>
<section id="implementation-of-higher-dimensional-forward-mode-ad" class="level3" data-number="7.3.2">
<h3 data-number="7.3.2" class="anchored" data-anchor-id="implementation-of-higher-dimensional-forward-mode-ad"><span class="header-section-number">7.3.2</span> Implementation of higher-dimensional forward-mode AD</h3>
<p>We can implement derivatives of functions <span class="math inline">\(f: \mathbb{R}^n \to \mathbb{R}\)</span> by adding several independent partial derivative components to our dual numbers.</p>
<p>We can think of these as <span class="math inline">\(\epsilon\)</span> perturbations in different directions, which satisfy <span class="math inline">\(\epsilon_i^2 = \epsilon_i \epsilon_j = 0\)</span>, and we will call <span class="math inline">\(\epsilon\)</span> the vector of all perturbations. Then we have</p>
<p><span class="math display">\[f(a + \epsilon) = f(a) + \nabla f(a) \cdot \epsilon + \mathcal{O}(\epsilon^2),\]</span></p>
<p>where <span class="math inline">\(a \in \mathbb{R}^n\)</span> and <span class="math inline">\(\nabla f(a)\)</span> is the <strong>gradient</strong> of <span class="math inline">\(f\)</span> at <span class="math inline">\(a\)</span>, i.e.&nbsp;the vector of partial derivatives in each direction. <span class="math inline">\(\nabla f(a) \cdot \epsilon\)</span> is the <strong>directional derivative</strong> of <span class="math inline">\(f\)</span> in the direction <span class="math inline">\(\epsilon\)</span>.</p>
<p>We now proceed similarly to the univariate case:</p>
<p><span class="math display">\[(f + g)(a + \epsilon) = [f(a) + g(a)] + [\nabla f(a) + \nabla g(a)] \cdot \epsilon\]</span></p>
<p><span class="math display">\[\begin{align}
(f \cdot g)(a + \epsilon) &amp;= [f(a) + \nabla f(a) \cdot \epsilon ] \, [g(a) + \nabla g(a) \cdot \epsilon ] \\
&amp;= f(a) g(a) + [f(a) \nabla g(a) + g(a) \nabla f(a)] \cdot \epsilon.
\end{align}\]</span></p>
<p>We will use the <code>StaticArrays.jl</code> package for efficient small vectors:</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">StaticArrays</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MultiDual{N,T}</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    val<span class="op">::</span><span class="dt">T</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    derivs<span class="op">::</span><span class="dt">SVector{N,T}</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Base</span>: +, *</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">+</span>(f<span class="op">::</span><span class="dt">MultiDual{N,T}</span>, g<span class="op">::</span><span class="dt">MultiDual{N,T}</span>) <span class="kw">where</span> {N,T}</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">MultiDual</span><span class="dt">{N,T}</span>(f.val <span class="op">+</span> g.val, f.derivs <span class="op">+</span> g.derivs)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">*</span>(f<span class="op">::</span><span class="dt">MultiDual{N,T}</span>, g<span class="op">::</span><span class="dt">MultiDual{N,T}</span>) <span class="kw">where</span> {N,T}</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">MultiDual</span><span class="dt">{N,T}</span>(f.val <span class="op">*</span> g.val, f.val <span class="op">.*</span> g.derivs <span class="op">+</span> g.val <span class="op">.*</span> f.derivs)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>* (generic function with 335 methods)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gcubic</span>(x, y) <span class="op">=</span> x<span class="op">*</span>x<span class="op">*</span>y <span class="op">+</span> x <span class="op">+</span> y</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>(a, b) <span class="op">=</span> (<span class="fl">1.0</span>, <span class="fl">2.0</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>xx <span class="op">=</span> <span class="fu">MultiDual</span>(a, <span class="fu">SVector</span>(<span class="fl">1.0</span>, <span class="fl">0.0</span>))</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>yy <span class="op">=</span> <span class="fu">MultiDual</span>(b, <span class="fu">SVector</span>(<span class="fl">0.0</span>, <span class="fl">1.0</span>))</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="fu">gcubic</span>(xx, yy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>MultiDual{2, Float64}(5.0, [5.0, 2.0])</code></pre>
</div>
</div>
<p>We can calculate the Jacobian of a function <span class="math inline">\(\mathbb{R}^n \to \mathbb{R}^m\)</span> by applying this to each component function:</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fsvec</span>(x, y) <span class="op">=</span> <span class="fu">SVector</span>(x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y , x <span class="op">+</span> y)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fsvec</span>(xx, yy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>2-element SVector{2, MultiDual{2, Float64}} with indices SOneTo(2):
 MultiDual{2, Float64}(5.0, [2.0, 4.0])
 MultiDual{2, Float64}(3.0, [1.0, 1.0])</code></pre>
</div>
</div>
<p>It would be possible (and better for performance in many cases) to store all of the partials in a matrix instead.</p>
<p>Forward-mode AD is implemented in a clean and efficient way in the <code>ForwardDiff.jl</code> package:</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ForwardDiff</span>, <span class="bu">StaticArrays</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>ForwardDiff.<span class="fu">gradient</span>( xx <span class="op">-&gt;</span> ( (x, y) <span class="op">=</span> xx; x<span class="op">^</span><span class="fl">2</span> <span class="op">*</span> y <span class="op">+</span> x<span class="op">*</span>y ), [<span class="fl">1</span>, <span class="fl">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>2-element Vector{Int64}:
 6
 2</code></pre>
</div>
</div>
</section>
<section id="directional-derivative-and-gradient-of-functions-f-mathbbrn-to-mathbbr" class="level3" data-number="7.3.3">
<h3 data-number="7.3.3" class="anchored" data-anchor-id="directional-derivative-and-gradient-of-functions-f-mathbbrn-to-mathbbr"><span class="header-section-number">7.3.3</span> Directional derivative and gradient of functions <span class="math inline">\(f: \mathbb{R}^n \to \mathbb{R}\)</span></h3>
<p>For a function <span class="math inline">\(f: \mathbb{R}^n \to \mathbb{R}\)</span> the basic operation is the <strong>directional derivative</strong>:</p>
<p><span class="math display">\[\lim_{\epsilon \to 0} \frac{f(\mathbf{x} + \epsilon \mathbf{v}) - f(\mathbf{x})}{\epsilon} =
[\nabla f(\mathbf{x})] \cdot \mathbf{v},\]</span></p>
<p>where <span class="math inline">\(\epsilon\)</span> is still a single dimension and <span class="math inline">\(\nabla f(\mathbf{x})\)</span> is the direction in which we calculate.</p>
<p>We can directly do this using the same simple <code>Dual</code> numbers as above, using the <em>same</em> <span class="math inline">\(\epsilon\)</span>, e.g.</p>
<p><span class="math display">\[f(x, y) = x^2  \sin(y)\]</span></p>
<p><span class="math display">\[\begin{align}
f(x_0 + a\epsilon, y_0 + b\epsilon) &amp;= (x_0 + a\epsilon)^2  \sin(y_0 + b\epsilon) \\
&amp;= x_0^2  \sin(y_0) + \epsilon[2ax_0  \sin(y_0) + x_0^2 b \cos(y_0)] + o(\epsilon)
\end{align}\]</span></p>
<p>so we have indeed calculated <span class="math inline">\(\nabla f(x_0, y_0) \cdot \mathbf{v},\)</span> where <span class="math inline">\(\mathbf{v} = (a, b)\)</span> are the components that we put into the derivative component of the <code>Dual</code> numbers.</p>
<p>If we wish to calculate the directional derivative in another direction, we could repeat the calculation with a different <span class="math inline">\(\mathbf{v}\)</span>. A better solution is to use another independent epsilon <span class="math inline">\(\epsilon\)</span>, expanding <span class="math display">\[x = x_0 + a_1 \epsilon_1 + a_2 \epsilon_2\]</span> and putting <span class="math inline">\(\epsilon_1 \epsilon_2 = 0\)</span>.</p>
<p>In particular, if we wish to calculate the gradient itself, <span class="math inline">\(\nabla f(x_0, y_0)\)</span>, we need to calculate both partial derivatives, which corresponds to two directional derivatives, in the directions <span class="math inline">\((1, 0)\)</span> and <span class="math inline">\((0, 1)\)</span>, respectively.</p>
</section>
<section id="forward-mode-ad-as-jvp" class="level3" data-number="7.3.4">
<h3 data-number="7.3.4" class="anchored" data-anchor-id="forward-mode-ad-as-jvp"><span class="header-section-number">7.3.4</span> Forward-Mode AD as jvp</h3>
<p>Note that another representation of the directional derivative is <span class="math inline">\(f'(x)v\)</span>, where <span class="math inline">\(f'(x)\)</span> is the Jacobian or total derivative of <span class="math inline">\(f\)</span> at <span class="math inline">\(x\)</span>. To see the equivalence of this to a directional derivative, write it out in the standard basis:</p>
<p><span class="math display">\[w_i = \sum_{j}^{m} J_{ij} v_{j}\]</span></p>
<p>Now write out what <span class="math inline">\(J\)</span> means and we see that:</p>
<p><span class="math display">\[w_i = \sum_j^{m} \frac{df_i}{dx_j} v_j = \nabla f_i(x) \cdot v\]</span></p>
<p><strong>The primitive action of forward-mode AD is <span class="math inline">\(f'(x)v\)</span>!</strong></p>
<p>This is also known as a <em>Jacobian-vector product</em>, or <em>jvp</em> for short.</p>
<p>We can thus represent vector calculus with multidimensional dual numbers as follows. Let <span class="math inline">\(d =[x,y]\)</span>, the vector of dual numbers. We can instead represent this as:</p>
<p><span class="math display">\[d = d_0 + v_1 \epsilon_1 + v_2 \epsilon_2\]</span></p>
<p>where <span class="math inline">\(d_0\)</span> is the <em>primal</em> vector <span class="math inline">\([x_0,y_0]\)</span> and the <span class="math inline">\(v_i\)</span> are the vectors for the <em>dual</em> directions. If you work out this algebra, then note that a single application of <span class="math inline">\(f\)</span> to a multidimensional dual number calculates:</p>
<p><span class="math display">\[f(d) = f(d_0) + f'(d_0)v_1 \epsilon_1 + f'(d_0)v_2 \epsilon_2\]</span></p>
<p>i.e.&nbsp;it calculates the result of <span class="math inline">\(f(x,y)\)</span> and two separate directional derivatives. Note that because the information about <span class="math inline">\(f(d_0)\)</span> is shared between the calculations, this is more efficient than doing multiple applications of <span class="math inline">\(f\)</span>. And of course, this is then generalized to <span class="math inline">\(m\)</span> many directional derivatives at once by:</p>
<p><span class="math display">\[d = d_0 + v_1 \epsilon_1 + v_2 \epsilon_2 + \ldots + v_m \epsilon_m\]</span></p>
</section>
<section id="jacobian" class="level3" data-number="7.3.5">
<h3 data-number="7.3.5" class="anchored" data-anchor-id="jacobian"><span class="header-section-number">7.3.5</span> Jacobian</h3>
<p>For a function <span class="math inline">\(f: \mathbb{R}^n \to \mathbb{R}^m\)</span>, we reduce (conceptually, although not necessarily in code) to its component functions <span class="math inline">\(f_i: \mathbb{R}^n \to \mathbb{R}\)</span>, where <span class="math inline">\(f(x) = (f_1(x), f_2(x), \ldots, f_m(x))\)</span>.</p>
<p>Then</p>
<p><span class="math display">\[\begin{align}
f(x + \epsilon v) &amp;= (f_1(x + \epsilon v), \ldots, f_m(x + \epsilon v)) \\
&amp;= (f_1(x) + \epsilon[\nabla f_1(x) \cdot v], \dots, f_m(x) + \epsilon[\nabla f_m(x) \cdot v] \\
&amp;= f(x) + [f'(x) \cdot v] \epsilon,
\end{align}\]</span></p>
<p>To calculate the complete Jacobian, we calculate these directional derivatives in the <span class="math inline">\(n\)</span> different directions of the basis vectors, i.e.&nbsp;if</p>
<p><span class="math inline">\(d = d_0 + e_1 \epsilon_1 + \ldots + e_n \epsilon_n\)</span></p>
<p>for <span class="math inline">\(e_i\)</span> the <span class="math inline">\(i\)</span>th basis vector, then</p>
<p><span class="math inline">\(f(d) = f(d_0) + Je_1 \epsilon_1 + \ldots + Je_n \epsilon_n\)</span></p>
<p>computes all columns of the Jacobian simultaneously.</p>
</section>
<section id="array-of-structs-representation" class="level3" data-number="7.3.6">
<h3 data-number="7.3.6" class="anchored" data-anchor-id="array-of-structs-representation"><span class="header-section-number">7.3.6</span> Array of Structs Representation</h3>
<p>Instead of thinking about a vector of dual numbers, thus we can instead think of dual numbers with vectors for the components. But if there are vectors for the components, then we can think of the grouping of dual components as a matrix. Thus define our multidimensional multi-partial dual number as:</p>
<p><span class="math display">\[D_0 = [d_1,d_2,d_3,\ldots,d_n]\]</span></p>
<p><span class="math display">\[\Sigma = \begin{bmatrix}
        d_{11} &amp; d_{12} &amp; \cdots &amp; d_{1n} \\
        d_{21} &amp; d_{22} &amp;  &amp; \vdots \\
        \vdots &amp; &amp; \ddots &amp; \vdots \\
        d_{m1} &amp; \hdots &amp; \hdots &amp; d_{mn}
    \end{bmatrix}\]</span></p>
<p><span class="math display">\[\epsilon=[\epsilon_1,\epsilon_2,\ldots,\epsilon_m]\]</span></p>
<p><span class="math display">\[D = D_0 + \Sigma \epsilon\]</span></p>
<p>where <span class="math inline">\(D_0\)</span> is a vector in <span class="math inline">\(\mathbb{R}^n\)</span>, <span class="math inline">\(\epsilon\)</span> is a vector of dimensional signifiers and <span class="math inline">\(\Sigma\)</span> is a matrix in <span class="math inline">\(\mathbb{R}^{n \times m}\)</span> where <span class="math inline">\(m\)</span> is the number of concurrent differentiation dimensions. Each row of this is a dual number, but now we can use this to easily define higher dimensional primitives.</p>
<p>For example, let <span class="math inline">\(f(x) = Ax\)</span>, matrix multiplication. Then, we can show with our dual number arithmetic that:</p>
<p><span class="math display">\[f(D) = A*D_0 + A*\Sigma*\epsilon\]</span></p>
<p>is how one would compute the value of <span class="math inline">\(f(D_0)\)</span> and the derivative <span class="math inline">\(f'(D_0)\)</span> in all directions signified by the columns of <span class="math inline">\(\Sigma\)</span> simultaneously. Using multidimensional Taylor series expansions and doing the manipulations like before indeed implies that the arithmetic on this object should follow:</p>
<p><span class="math display">\[f(D) = f(D_0) + f'(D_0)\Sigma \epsilon\]</span></p>
<p>where <span class="math inline">\(f'\)</span> is the total derivative or the Jacobian of <span class="math inline">\(f\)</span>. This then allows our system to be highly efficient by allowing the definition of multidimensional functions, like linear algebra, to be primitives of multi-directional derivatives.</p>
</section>
<section id="higher-derivatives" class="level3" data-number="7.3.7">
<h3 data-number="7.3.7" class="anchored" data-anchor-id="higher-derivatives"><span class="header-section-number">7.3.7</span> Higher derivatives</h3>
<p>The above techniques can be extended to higher derivatives by <em>adding more terms to the Taylor polynomial</em>, e.g.</p>
<p><span class="math display">\[f(a + \epsilon) = f(a) + \epsilon f'(a) + \frac{1}{2} \epsilon^2 f''(a) + o(\epsilon^2).\]</span></p>
<p>We treat this as a degree-2 (or degree-<span class="math inline">\(n\)</span>, in general) polynomial and do polynomial arithmetic to calculate the new polynomials. The coefficients of powers of <span class="math inline">\(\epsilon\)</span> then give the higher-order derivatives.</p>
<p>For example, for a function <span class="math inline">\(f: \mathbb{R}^n \to \mathbb{R}\)</span> we have</p>
<p><span class="math display">\[f(x + \epsilon v) = f(x) + \epsilon \left[ \sum_i (\partial_i f)(x) v_i \right] + \frac{1}{2}\epsilon^2 \left[ \sum_i \sum_j (\partial_{i,j} f) v_i v_j \right]\]</span></p>
<p>using <code>Dual</code> numbers with a single <span class="math inline">\(\epsilon\)</span> component. In this way we can compute coefficients of the (symmetric) Hessian matrix.</p>
</section>
</section>
<section id="application-solving-nonlinear-equations-using-the-newton-method" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="application-solving-nonlinear-equations-using-the-newton-method"><span class="header-section-number">7.4</span> Application: solving nonlinear equations using the Newton method</h2>
<p>As an application, we will see how to solve nonlinear equations of the form <span class="math display">\[f(x) = 0\]</span> for functions <span class="math inline">\(f: \mathbb{R}^n \to \mathbb{R}^n\)</span>.</p>
<p>Since in general we cannot do anything with nonlinearity, we try to reduce it (approximate it) with something linear. Furthermore, in general we know that it is not possible to solve nonlinear equations in closed form (even for polynomials of degree <span class="math inline">\(\ge 5\)</span>), so we will need some kind of iterative method.</p>
<p>We start from an initial guess <span class="math inline">\(x_0\)</span>. The idea of the <strong>Newton method</strong> is to follow the tangent line to the function <span class="math inline">\(f\)</span> at the point <span class="math inline">\(x_0\)</span> and find where it intersects the <span class="math inline">\(x\)</span>-axis; this will give the next iterate <span class="math inline">\(x_1\)</span>.</p>
<p>Algebraically, we want to solve <span class="math inline">\(f(x_1) = 0\)</span>. Suppose that <span class="math inline">\(x_1 = x_0 + \delta\)</span> for some <span class="math inline">\(\delta\)</span> that is currently unknown and which we wish to calculate.</p>
<p>Assuming <span class="math inline">\(\delta\)</span> is small, we can expand:</p>
<p><span class="math display">\[f(x_1) = f(x_0 + \delta) = f(x_0) + Df(x_0) \cdot \delta + \mathcal{O}(\| \delta \|^2).\]</span></p>
<p>Since we wish to solve</p>
<p><span class="math display">\[f(x_0 + \delta) \simeq 0,\]</span></p>
<p>we put</p>
<p><span class="math display">\[f(x_0) + Df(x_0) \cdot \delta = 0,\]</span></p>
<p>so that <em>mathematically</em> we have</p>
<p><span class="math display">\[\delta = -[Df(x_0)]^{-1} \cdot f(x_0).\]</span></p>
<p>Computationally we prefer to solve the matrix equation</p>
<p><span class="math display">\[J \delta = -f(x_0),\]</span></p>
<p>where <span class="math inline">\(J := Df(x_0)\)</span> is the Jacobian of the function; Julia uses the syntax <code>\</code> (“backslash”) for solving linear systems in an efficient way:</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ForwardDiff</span>, <span class="bu">StaticArrays</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">newton_step</span>(f, x0)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    J <span class="op">=</span> ForwardDiff.<span class="fu">jacobian</span>(f, x0)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    δ <span class="op">=</span> J <span class="op">\</span> <span class="fu">f</span>(x0)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x0 <span class="op">-</span> δ</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">newton</span>(f, x0)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x0</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="fu">newton_step</span>(f, x)</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@show</span> x</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="fu">fsvec2</span>(xx) <span class="op">=</span> ( (x, y) <span class="op">=</span> xx;  <span class="fu">SVector</span>(x<span class="op">^</span><span class="fl">2</span> <span class="op">+</span> y<span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">1</span>, x <span class="op">-</span> y) )</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>x0 <span class="op">=</span> <span class="fu">SVector</span>(<span class="fl">3.0</span>, <span class="fl">5.0</span>)</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fu">newton</span>(fsvec2, x0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>x = [2.1875, 2.1875]
x = [1.2080357142857143, 1.2080357142857143]
x = [0.8109653811635519, 0.8109653811635519]
x = [0.7137572554482892, 0.7137572554482892]
x = [0.7071377642746832, 0.7071377642746832]
x = [0.7071067818653062, 0.7071067818653062]
x = [0.7071067811865475, 0.7071067811865475]
x = [0.7071067811865476, 0.7071067811865476]
x = [0.7071067811865475, 0.7071067811865475]
x = [0.7071067811865476, 0.7071067811865476]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>2-element SVector{2, Float64} with indices SOneTo(2):
 0.7071067811865476
 0.7071067811865476</code></pre>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">7.5</span> Conclusion</h2>
<p>To make derivative calculations efficient and correct, we can move to higher dimensional numbers. In multiple dimensions, these then allow for multiple directional derivatives to be computed simultaneously, giving a method for computing the Jacobian of a function <span class="math inline">\(f\)</span> on a single input. This is a direct application of using the compiler as part of a mathematical framework.</p>
<section id="references" class="level3" data-number="7.5.1">
<h3 data-number="7.5.1" class="anchored" data-anchor-id="references"><span class="header-section-number">7.5.1</span> References</h3>
<ul>
<li>John L. Bell, <em>An Invitation to Smooth Infinitesimal Analysis</em>, http://publish.uwo.ca/~jbell/invitation%20to%20SIA.pdf</li>
<li>Bell, John L. <em>A Primer of Infinitesimal Analysis</em></li>
<li>Nocedal &amp; Wright, <em>Numerical Optimization</em>, Chapter 8</li>
<li>Griewank &amp; Walther, <em>Evaluating Derivatives</em></li>
</ul>
<p>Many thanks to David Sanders for helping make these lecture notes.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./discretizing_odes.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Ordinary Differential Equations, Applications and Discretizations</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./stiff_odes.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Solving Stiff Ordinary Differential Equations</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>